<!doctype html><html lang=ja dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  3日目
  #

2日目まででタスク一覧をサーバに対して要求して、レスポンスに応じてタスク一覧を画面に描画するフロントエンドができました。
ただ、現時点でリクエストに対して応答するバックエンドがまだありませんので、これを作っていきましょう。"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://onebase-fujitsu.github.io/agile-dev-guide/docs/practice/day3/"><meta property="og:site_name" content="Fujitsu Agile Development Guide"><meta property="og:title" content="3日目"><meta property="og:description" content="3日目 # 2日目まででタスク一覧をサーバに対して要求して、レスポンスに応じてタスク一覧を画面に描画するフロントエンドができました。 ただ、現時点でリクエストに対して応答するバックエンドがまだありませんので、これを作っていきましょう。"><meta property="og:locale" content="ja"><meta property="og:type" content="article"><meta property="article:section" content="docs"><title>3日目 | Fujitsu Agile Development Guide</title>
<link rel=icon href=/agile-dev-guide/favicon.png><link rel=manifest href=/agile-dev-guide/manifest.json><link rel=canonical href=https://onebase-fujitsu.github.io/agile-dev-guide/docs/practice/day3/><link rel=stylesheet href=/agile-dev-guide/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/agile-dev-guide/><span>Fujitsu Agile Development Guide</span></a></h2><ul><li><a href=/agile-dev-guide/docs/introduction/>はじめに</a></li><li><input type=checkbox id=section-fe72557a7878dded4efa0060e21abacc class=toggle>
<label for=section-fe72557a7878dded4efa0060e21abacc class="flex justify-between"><a role=button>アジャイル</a></label><ul><li><a href=/agile-dev-guide/docs/agile/manifest/>アジャイルソフトウェア開発宣言</a></li><li><a href=/agile-dev-guide/docs/agile/principle/>アジャイル開発12の原則</a></li><li><a href=/agile-dev-guide/docs/agile/conclude/>まとめ</a></li></ul></li><li><input type=checkbox id=section-60906829343241fe59efbb09409d99f8 class=toggle>
<label for=section-60906829343241fe59efbb09409d99f8 class="flex justify-between"><a role=button>スクラム</a></label><ul><li><a href=/agile-dev-guide/docs/scrum/overview/>スクラムとは</a></li><li><a href=/agile-dev-guide/docs/scrum/roles/>ロール</a></li><li><a href=/agile-dev-guide/docs/scrum/products/>成果物</a></li><li><a href=/agile-dev-guide/docs/scrum/events/>イベント</a></li><li><a href=/agile-dev-guide/docs/scrum/conclude/>まとめ</a></li></ul></li><li><input type=checkbox id=section-8258873460fa80799dab8ced5b37f178 class=toggle>
<label for=section-8258873460fa80799dab8ced5b37f178 class="flex justify-between"><a role=button>エクストリームプログラミング</a></label><ul><li><a href=/agile-dev-guide/docs/xp/overview/>エクストリームプログラミングとは</a></li><li><a href=/agile-dev-guide/docs/xp/practice/>エクストリームプログラミングのプラクティス</a></li><li><a href=/agile-dev-guide/docs/xp/conclude/>まとめ</a></li></ul></li><li><input type=checkbox id=section-ef522355473a56c6b477dd934de57bb8 class=toggle>
<label for=section-ef522355473a56c6b477dd934de57bb8 class="flex justify-between"><a role=button>ソフトウェアテスト</a></label><ul><li><a href=/agile-dev-guide/docs/softwaretest/overview/>ソフトウェアテストを始めよう</a></li><li><a href=/agile-dev-guide/docs/softwaretest/fizzbuzz/>ウォーミングアップ</a></li><li><a href=/agile-dev-guide/docs/softwaretest/bowlinggame/>ボウリングゲーム</a></li><li><a href=/agile-dev-guide/docs/softwaretest/testdouble/>テストダブル</a></li><li><a href=/agile-dev-guide/docs/softwaretest/e2e/>E2Eテスト</a></li></ul></li><li><input type=checkbox id=section-c09385b1b773ce6e3a59f711992fc86e class=toggle>
<label for=section-c09385b1b773ce6e3a59f711992fc86e class="flex justify-between"><a role=button>ソフトウェア設計</a></label><ul><li><a href=/agile-dev-guide/docs/softwaredesign/about/>アジャイル開発に求められるソフトウェア設計</a></li><li><input type=checkbox id=section-af89c1e488b0f5f376cd7b5e25174bc5 class=toggle>
<label for=section-af89c1e488b0f5f376cd7b5e25174bc5 class="flex justify-between"><a role=button>SOLID原則</a></label><ul><li><a href=/agile-dev-guide/docs/softwaredesign/solidprinciple/srp/>単一責任の原則(SRP)</a></li><li><a href=/agile-dev-guide/docs/softwaredesign/solidprinciple/ocp/>オープン・クローズドの原則(OCP)</a></li><li><a href=/agile-dev-guide/docs/softwaredesign/solidprinciple/lsp/>リスコフの置換原則(LSP)</a></li><li><a href=/agile-dev-guide/docs/softwaredesign/solidprinciple/dip/>依存性逆転の原則(DIP)</a></li><li><a href=/agile-dev-guide/docs/softwaredesign/solidprinciple/isp/>インターフェース分離の原則(ISP)</a></li></ul></li><li><input type=checkbox id=section-866eec1f3dcfccd287cfe06fbdb82bb8 class=toggle>
<label for=section-866eec1f3dcfccd287cfe06fbdb82bb8 class="flex justify-between"><a role=button>デザインパターン</a></label><ul><li><a href=/agile-dev-guide/docs/softwaredesign/designpattern/designpattern/>デザインパターン</a></li></ul></li></ul></li><li><input type=checkbox id=section-ffa226df7ff6fdab04824ed978163e3a class=toggle checked>
<label for=section-ffa226df7ff6fdab04824ed978163e3a class="flex justify-between"><a role=button>アジャイルの実践</a></label><ul><li><a href=/agile-dev-guide/docs/practice/day1/>1日目</a></li><li><a href=/agile-dev-guide/docs/practice/day2/>2日目</a></li><li><a href=/agile-dev-guide/docs/practice/day3/ class=active>3日目</a></li><li><a href=/agile-dev-guide/docs/practice/day4/>4日目</a></li><li><a href=/agile-dev-guide/docs/practice/day5/>5日目</a></li><li><a href=/agile-dev-guide/docs/practice/day6/>6日目</a></li></ul></li><li><a href=/agile-dev-guide/docs/inclosing/>おわりに</a></li><li><a href=/agile-dev-guide/docs/recommendedbooks/>推奨書籍</a></li><li class=book-section-flat><span>全体編</span><ul><li><input type=checkbox id=section-c08c824050a314a836aa6f2a3533d6f4 class=toggle>
<label for=section-c08c824050a314a836aa6f2a3533d6f4 class="flex justify-between"><a role=button>リーンスタートアップアジャイル</a></label><ul><li><a href=/agile-dev-guide/docs/framework/leanstartup/overview/>リーンスタートアップアジャイルの流れ</a></li><li><a href=/agile-dev-guide/docs/framework/leanstartup/organization/>体制・役割</a></li><li><a href=/agile-dev-guide/docs/framework/leanstartup/productvision/>プロダクトビジョン / バリュープロポジション</a></li></ul></li><li><input type=checkbox id=section-4843f470e01d88c8920f705055d62d32 class=toggle>
<label for=section-4843f470e01d88c8920f705055d62d32 class="flex justify-between"><a role=button>モダナイゼーションアジャイル</a></label><ul><li><a href=/agile-dev-guide/docs/framework/modernization/overview/>モダナイゼーションアジャイルの流れ</a></li><li><a href=/agile-dev-guide/docs/framework/modernization/organization/>体制・役割</a></li><li><input type=checkbox id=section-16e7420deaec3bf622c47c912e4fe6b1 class=toggle>
<label for=section-16e7420deaec3bf622c47c912e4fe6b1 class="flex justify-between"><a role=button>Swift Method</a></label><ul><li><a href=/agile-dev-guide/docs/framework/modernization/swift/overview/>Swift Method とは</a></li><li><a href=/agile-dev-guide/docs/framework/modernization/swift/eventstorming/>Event Storming</a></li><li><a href=/agile-dev-guide/docs/framework/modernization/swift/boris/>Boris</a></li><li><a href=/agile-dev-guide/docs/framework/modernization/swift/snape/>SnapE</a></li><li><a href=/agile-dev-guide/docs/framework/modernization/swift/slices/>Slices</a></li><li><a href=/agile-dev-guide/docs/framework/modernization/swift/techchoice/>Tech Choice</a></li></ul></li></ul></li></ul></li><li class=book-section-flat><span>Team編</span><ul><li><a href=/agile-dev-guide/docs/team/workstyle/>チームの働き方</a></li><li><a href=/agile-dev-guide/docs/team/balancedteam/>バランスチーム</a></li><li><input type=checkbox id=section-a232289a72ea66e3aa7212c269a1f858 class=toggle>
<label for=section-a232289a72ea66e3aa7212c269a1f858 class="flex justify-between"><a role=button>マインドセット</a></label><ul><li><a href=/agile-dev-guide/docs/team/mindset/onebase/>ONEbaseの価値観</a></li><li><a href=/agile-dev-guide/docs/team/mindset/psychologicalsafety/>心理的安全性</a></li><li><a href=/agile-dev-guide/docs/team/mindset/xp/>XPの価値観</a></li><li><a href=/agile-dev-guide/docs/team/mindset/practice/>プラクティスの取り入れ方</a></li></ul></li><li><a href=/agile-dev-guide/docs/team/teambuilding/>チームビルディング</a></li><li><a href=/agile-dev-guide/docs/team/remotework/>リモートワーク</a></li><li><input type=checkbox id=section-110f9959d63e8c110b8745fc9d06c772 class=toggle>
<label for=section-110f9959d63e8c110b8745fc9d06c772 class="flex justify-between"><a role=button>チームのアクティビティ</a></label><ul><li><a href=/agile-dev-guide/docs/team/activities/officestandup/>全体スタンドアップ</a></li><li><a href=/agile-dev-guide/docs/team/activities/teamstandup/>チームスタンドアップ</a></li><li><a href=/agile-dev-guide/docs/team/activities/preipm/>Pre-IPM</a></li><li><a href=/agile-dev-guide/docs/team/activities/ipm/>IPM</a></li><li><a href=/agile-dev-guide/docs/team/activities/cl/>CLミーティング</a></li><li><a href=/agile-dev-guide/docs/team/activities/retro/>レトロスペクティブ</a></li><li><a href=/agile-dev-guide/docs/team/activities/salesmeeting/>営業確認会議</a></li><li><a href=/agile-dev-guide/docs/team/activities/internalsync/>Internal Sync</a></li><li><a href=/agile-dev-guide/docs/team/activities/riskmitigations/>Risks & Mitigations</a></li><li><a href=/agile-dev-guide/docs/team/activities/feedback/>フィードバック</a></li><li><a href=/agile-dev-guide/docs/team/activities/icebreak/>Ice Break</a></li><li><a href=/agile-dev-guide/docs/team/activities/teamhealthcheck/>Team Health Check</a></li><li><a href=/agile-dev-guide/docs/team/activities/1on1/>1on1</a></li><li><a href=/agile-dev-guide/docs/team/activities/exercise/>ラジオ体操</a></li></ul></li><li><input type=checkbox id=section-bdb63741ec425eaf58eeca20fa22f0f7 class=toggle>
<label for=section-bdb63741ec425eaf58eeca20fa22f0f7 class="flex justify-between"><a role=button>チームのプラクティス</a></label><ul><li><a href=/agile-dev-guide/docs/team/practices/facilitation/>ファシリテーション</a></li><li><a href=/agile-dev-guide/docs/team/practices/okrs/>OKRs</a></li></ul></li></ul></li><li class=book-section-flat><span>Designer編</span><ul><li><a href=/agile-dev-guide/docs/designer/overview/>Designerとは</a></li><li><input type=checkbox id=section-a01b867896ae9f1f3928ca93b2070a69 class=toggle>
<label for=section-a01b867896ae9f1f3928ca93b2070a69 class="flex justify-between"><a role=button>Designerのプラクティス</a></label><ul><li><a href=/agile-dev-guide/docs/designer/practices/persona/>ペルソナ</a></li><li><a href=/agile-dev-guide/docs/designer/practices/scenario/>シナリオ</a></li><li><a href=/agile-dev-guide/docs/designer/practices/researchplanning/>リサーチ計画立案</a></li><li><a href=/agile-dev-guide/docs/designer/practices/prototyping/>プロトタイピング</a></li><li><a href=/agile-dev-guide/docs/designer/practices/script/>スクリプト作成</a></li><li><a href=/agile-dev-guide/docs/designer/practices/researchaction/>リサーチ実施</a></li><li><a href=/agile-dev-guide/docs/designer/practices/synthesize/>シンセサイズ</a></li></ul></li></ul></li><li class=book-section-flat><span>Product Manager編</span><ul><li><a href=/agile-dev-guide/docs/productmanager/overview/>Product Managerとは</a></li><li><input type=checkbox id=section-d59afdd8070324cbcc7435686b4f2086 class=toggle>
<label for=section-d59afdd8070324cbcc7435686b4f2086 class="flex justify-between"><a role=button>Product Managerのプラクティス</a></label><ul><li><a href=/agile-dev-guide/docs/productmanager/practices/roadmap/>プロダクトロードマップ</a></li><li><a href=/agile-dev-guide/docs/productmanager/practices/mvp/>MVP</a></li><li><a href=/agile-dev-guide/docs/productmanager/practices/userstorymapping/>ユーザーストーリーマッピング</a></li><li><a href=/agile-dev-guide/docs/productmanager/practices/userstory/>ユーザーストーリー</a></li><li><a href=/agile-dev-guide/docs/productmanager/practices/2x2/>2×2</a></li></ul></li></ul></li><li class=book-section-flat><span>Developer編</span><ul><li><a href=/agile-dev-guide/docs/developer/overview/>Developerとは</a></li><li><input type=checkbox id=section-efb8318f4d88b390e60e256084f8f4ac class=toggle>
<label for=section-efb8318f4d88b390e60e256084f8f4ac class="flex justify-between"><a role=button>Developerのプラクティス</a></label><ul><li><a href=/agile-dev-guide/docs/developer/practices/tdd/>TDD</a></li><li><a href=/agile-dev-guide/docs/developer/practices/cicd/>CI/CD</a></li><li><a href=/agile-dev-guide/docs/developer/practices/pairprogramming/>ペアプログラミング</a></li><li><a href=/agile-dev-guide/docs/developer/practices/soroprogramming/>ソロプログラミング</a></li></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/agile-dev-guide/svg/menu.svg class=book-icon alt=Menu></label><h3>3日目</h3><label for=toc-control><img src=/agile-dev-guide/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#バックエンドの初期設定>バックエンドの初期設定</a><ul><li><a href=#spring-bootのプロジェクト作成>Spring Bootのプロジェクト作成</a></li><li><a href=#dbの設定>DBの設定</a></li><li><a href=#dbのマイグレーションツールの導入>DBのマイグレーションツールの導入</a></li></ul></li><li><a href=#get-todosの実装>GET /todosの実装</a><ul><li><a href=#get-todosのテスト>GET /todosのテスト</a></li><li><a href=#get-todosの実装-1>GET /todosの実装</a></li></ul></li><li><a href=#クライアントとサーバの連携>クライアントとサーバの連携</a></li><li><a href=#に置いてあります>ここまでのソースは
<a href=https://github.com/onebase-fujitsu/todo-app-vite/tree/feature/step6>https://github.com/onebase-fujitsu/todo-app-vite/tree/feature/step6</a>
に置いてあります。</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=3日目>3日目
<a class=anchor href=#3%e6%97%a5%e7%9b%ae>#</a></h1><p>2日目まででタスク一覧をサーバに対して要求して、レスポンスに応じてタスク一覧を画面に描画するフロントエンドができました。
ただ、現時点でリクエストに対して応答するバックエンドがまだありませんので、これを作っていきましょう。</p><h2 id=バックエンドの初期設定>バックエンドの初期設定
<a class=anchor href=#%e3%83%90%e3%83%83%e3%82%af%e3%82%a8%e3%83%b3%e3%83%89%e3%81%ae%e5%88%9d%e6%9c%9f%e8%a8%ad%e5%ae%9a>#</a></h2><h3 id=spring-bootのプロジェクト作成>Spring Bootのプロジェクト作成
<a class=anchor href=#spring-boot%e3%81%ae%e3%83%97%e3%83%ad%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e4%bd%9c%e6%88%90>#</a></h3><p>Spring Bootのプロジェクトを作成するときはIntelliJの「新規ブロジェクト作成」からSpring Bootを選択すると簡単です。</p><p><img src=IntelliJ_newProject.png alt=IntelliJ_generate>
<img src=IntelliJ_generate1.png alt=IntelliJ_generate>
<img src=IntelliJ_generate2.png alt=IntelliJ_generate></p><p>生成場所はtodo-app-clientと並列になるようにしましょう。
今回はGradle Projectで開発言語はKotlinにします。</p><p>Spring Bootのバージョンはその時の安定版を指定すると良いです。</p><p>Artifact名は今回はtodo-app-serverとしました。
依存ライブラリですが、後からでも追加できますので、ここではいったん、Spring Webのみ追加しました。</p><p>これでGenerateしましょう。</p><p>※<a href=https://start.spring.io/>Spring Initializr</a> でプロジェクトを作成することもできます。</p><h3 id=dbの設定>DBの設定
<a class=anchor href=#db%e3%81%ae%e8%a8%ad%e5%ae%9a>#</a></h3><p>例によってアプリ作成は初期設定が一番大変です。頑張っていきましょう。
まず、DBの設定をしていきましょう。</p><p>今回DBは <a href=https://www.postgresql.org/>PostgreSQL</a> を使用しようと思います。
ソフトウェアテストの章でつかったサンプルアプリケーションではH2をインメモリで動かしていたのですが、
流石に実際の開発のときにそんなことはしないので、実際の開発に寄せる意味でもPostgreSQLにしてみます。</p><p>まだPostgreSQLをインストールしていない方はPostgreSQLを導入してください。</p><p>PostgreSQLをサービスとしてローカルで動いているのを確認したら、
<a href=https://www.postgresql.jp/document/9.4/html/app-createdb.html>createdb</a> コマンドを実行してtodo_dbを作っておきましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>createdb todo_db
</span></span></code></pre></div><p>まず、DB接続に必要なライブラリを追加しましょう。build.gradle.ktsを開いたらdependenciesを以下のように変更してください。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#75715e>// build.gradle.kts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>dependencies {
</span></span><span style=display:flex><span>    implementation(<span style=color:#e6db74>&#34;org.springframework.boot:spring-boot-starter-web&#34;</span>)
</span></span><span style=display:flex><span>    implementation(<span style=color:#e6db74>&#34;com.fasterxml.jackson.module:jackson-module-kotlin&#34;</span>)
</span></span><span style=display:flex><span>    implementation(<span style=color:#e6db74>&#34;org.jetbrains.kotlin:kotlin-reflect&#34;</span>)
</span></span><span style=display:flex><span>    implementation(<span style=color:#e6db74>&#34;org.jetbrains.kotlin:kotlin-stdlib-jdk8&#34;</span>)
</span></span><span style=display:flex><span>    implementation(<span style=color:#e6db74>&#34;org.springframework.boot:spring-boot-starter-jdbc&#34;</span>)   <span style=color:#75715e>// 追記
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    runtimeOnly(<span style=color:#e6db74>&#34;org.postgresql:postgresql&#34;</span>)                              <span style=color:#75715e>// 追記
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    testImplementation(<span style=color:#e6db74>&#34;org.springframework.boot:spring-boot-starter-test&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>次にsrc/resources/application.propertiesがありますが、yamlで記述したほうが見通しが良くなるので、
このapplication.propertiesをapplication.ymlに変更します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>// application.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:postgresql://localhost:5432/${DB_NAME:todo_db}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>username</span>: <span style=color:#ae81ff>onebase</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>:
</span></span></code></pre></div><p>設定ファイルはこのように変更します。<strong>usernameは<code>createdb</code>コマンドを実行した環境に依存しますので、皆様の環境に合わせて書き換えてください。</strong>
この状態でアプリケーションを起動してみましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./gradlew bootRun
</span></span></code></pre></div><pre tabindex=0><code>onebase@Onebase-Maguro todo-app-server % ./gradlew bootRun

&gt; Task :bootRun

  .   ____          _            __ _ _
 /\\ / ___&#39;_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | &#39;_ | &#39;_| | &#39;_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  &#39;  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v2.5.4)

2021-09-12 04:38:21.169  INFO 74012 --- [           main] c.f.t.TodoAppServerApplicationKt         : Starting TodoAppServerApplicationKt using Java 13.0.2 on Onebase-Maguro.local with PID 74012 (/Users/onebase/IdeaProjects/todo-app-server/build/classes/kotlin/main started by onebase in /Users/onebase/IdeaProjects/todo-app-server)
2021-09-12 04:38:21.171  INFO 74012 --- [           main] c.f.t.TodoAppServerApplicationKt         : No active profile set, falling back to default profiles: default
2021-09-12 04:38:22.054  INFO 74012 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8080 (http)
2021-09-12 04:38:22.063  INFO 74012 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]
2021-09-12 04:38:22.064  INFO 74012 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.52]
2021-09-12 04:38:22.122  INFO 74012 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
2021-09-12 04:38:22.122  INFO 74012 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 910 ms
2021-09-12 04:38:22.451  INFO 74012 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path &#39;&#39;
2021-09-12 04:38:22.459  INFO 74012 --- [           main] c.f.t.TodoAppServerApplicationKt         : Started TodoAppServerApplicationKt in 1.844 seconds
&lt;==========---&gt; 83% EXECUTING [16s]
&gt; :bootRun
</code></pre><p>ひとまずこのような表示が出たらServerとPostgreSQL DBの接続はうまくいっていますので、<code>Control+C</code>を押してサーバを止めておきましょう。</p><h3 id=dbのマイグレーションツールの導入>DBのマイグレーションツールの導入
<a class=anchor href=#db%e3%81%ae%e3%83%9e%e3%82%a4%e3%82%b0%e3%83%ac%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%83%84%e3%83%bc%e3%83%ab%e3%81%ae%e5%b0%8e%e5%85%a5>#</a></h3><p>DBのマイグレーションツールを導入してみましょう。
先程<code>createdb</code>コマンドを実行してDBを作りましたが、まだテーブルを全く作ってません。
DBのスキーマを手動で管理するのはメチャクチャ大変ですので、マイグレーションツールを導入するとスキーマの作成や、スキーマ変更に伴うデータのマイグレーションを自動化することができます。</p><p>ここでは <a href=https://flywaydb.org/>Flyway</a> を使います。</p><p>再び、build.gradle.ktsを開いたら以下の依存を追加してください。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#75715e>// build.gradle.kts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>dependencies {
</span></span><span style=display:flex><span>    implementation(<span style=color:#e6db74>&#34;org.springframework.boot:spring-boot-starter-web&#34;</span>)
</span></span><span style=display:flex><span>    implementation(<span style=color:#e6db74>&#34;com.fasterxml.jackson.module:jackson-module-kotlin&#34;</span>)
</span></span><span style=display:flex><span>    implementation(<span style=color:#e6db74>&#34;org.jetbrains.kotlin:kotlin-reflect&#34;</span>)
</span></span><span style=display:flex><span>    implementation(<span style=color:#e6db74>&#34;org.springframework.boot:spring-boot-starter-jdbc&#34;</span>)
</span></span><span style=display:flex><span>    implementation(<span style=color:#e6db74>&#34;org.flywaydb:flyway-database-postgresql&#34;</span>)
</span></span><span style=display:flex><span>    runtimeOnly(<span style=color:#e6db74>&#34;org.postgresql:postgresql&#34;</span>)
</span></span><span style=display:flex><span>    testImplementation(<span style=color:#e6db74>&#34;org.springframework.boot:spring-boot-starter-test&#34;</span>)
</span></span><span style=display:flex><span>    testImplementation(<span style=color:#e6db74>&#34;org.jetbrains.kotlin:kotlin-test-junit5&#34;</span>)
</span></span><span style=display:flex><span>    testRuntimeOnly(<span style=color:#e6db74>&#34;org.junit.platform:junit-platform-launcher&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>次に、src/main/resources/application.ymlを再び開いてFlywayの設定を記入しましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>// application.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:postgresql://localhost:5432/${DB_NAME:todo_db}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>username</span>: <span style=color:#ae81ff>onebase</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>flyway</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>baseline-on-migrate</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:postgresql://localhost:5432/${DB_NAME:todo_db}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>user</span>: <span style=color:#ae81ff>onebase</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>:
</span></span></code></pre></div><p>これでFlywayを使う準備が整いました。では実際にマイグレーションをかけてテーブルを作ってみましょう。
src/main/resources配下にdbというディレクトリを作成し、さらにその配下にmigrationというディレクトリを作成します。
そして、そのmigration配下に<code>VyyyyMMddHHmmss__CreateTodoTable.sql</code>というファイルを新規に作ってください。
&lsquo;yyyyMMddHHmmss&rsquo;の部分は実際に作成作業をした時間に置き換えてください。
ファイル名がこの命名規約に従っていることがとても大事です。</p><pre tabindex=0><code>src
├── main
│     ├── kotlin
│     │     └── com
│     │         └── fujitsu
│     │             └── todoappserver
│     │                 └── TodoAppServerApplication.kt
│     └── resources
│         ├── application.yml
│         ├── db
│         │     └── migration
│         │         └── V20210912045400__CreateTodoTable.sql
│         ├── static
│         └── templates
└── test
    └── kotlin
        └── com
            └── fujitsu
                └── todoappserver
                    └── TodoAppServerApplicationTests.kt
</code></pre><p>筆者の例では「V20210912045400__CreateTodoTable.sql」というファイル名にしています。（このドキュメントは朝4時に書いています。）</p><p>このファイルにはマイグレーション用のSQLを記述します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> todo (
</span></span><span style=display:flex><span>    id serial <span style=color:#66d9ef>primary</span> <span style=color:#66d9ef>key</span>,
</span></span><span style=display:flex><span>    title varchar <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>    completed boolean <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>最初のSQLはこのようにしました。
この状態で再度アプリケーションを起動してみましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./gradlew bootRun
</span></span></code></pre></div><p>正常に起動したら、どのようなツールでも構いませんのでtodo_dbの状態をみてみましょう。</p><p><img src=flyway_migration.jpg alt="flyway migration"></p><p>flyway_schema_historyというテーブル共にtodoテーブルがFlywayによって作られていたら成功です。
Flywayはアプリケーション起動時にdb/migrationディレクトリ配下のSQLを確認して、DBのマイグレーションを実行してくれます。</p><p>これでバックエンド開発の下準備が整いました。ここまでのソースコードは
<a href=https://github.com/onebase-fujitsu/todo-app-vite/tree/feature/step5>https://github.com/onebase-fujitsu/todo-app-vite/tree/feature/step5</a>
に置いてあります。</p><h2 id=get-todosの実装>GET /todosの実装
<a class=anchor href=#get-todos%e3%81%ae%e5%ae%9f%e8%a3%85>#</a></h2><h3 id=get-todosのテスト>GET /todosのテスト
<a class=anchor href=#get-todos%e3%81%ae%e3%83%86%e3%82%b9%e3%83%88>#</a></h3><p>ではまず/todosに対してGETをしたときに、データベースにアクセスして、Todo一覧をJSON形式で返却するテストを書いてみましょう。
src/test/kotlin/com.fujitsu.todoappserver配下にcontrollerパッケージを作り、その中に<code>TodoApiControllerTest.kt</code>を作りましょう</p><pre tabindex=0><code>src
├── main
│     ├── kotlin
│     │     └── com
│     │         └── fujitsu
│     │             └── todoappserver
│     │                 └── TodoAppServerApplication.kt
│     └── resources
│         ├── application.yml
│         ├── db
│         │     └── migration
│         │         └── V20210912045400__CreateTodoTable.sql
│         ├── static
│         └── templates
└── test
    └── kotlin
        └── com
            └── fujitsu
                └── todoappserver
                    ├── TodoAppServerApplicationTests.kt
                    └── controller
                        └── TodoApiControllerTest.kt    // 作成
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#75715e>// TodoApiControllerTest.kt
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>package</span> com.fujitsu.todoappserver.controller
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> com.fasterxml.jackson.module.kotlin.jacksonObjectMapper
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> com.fasterxml.jackson.module.kotlin.readValue
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.assertj.core.api.Assertions
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.junit.jupiter.api.Test
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.springframework.beans.factory.annotation.Autowired
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.springframework.boot.test.context.SpringBootTest
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.springframework.boot.test.web.client.TestRestTemplate
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.springframework.http.*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(webEnvironment = <span style=color:#a6e22e>SpringBootTest</span>.<span style=color:#a6e22e>WebEnvironment</span>.RANDOM_PORT)
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TodoApiControllerTest</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>lateinit</span> <span style=color:#66d9ef>var</span> restTemplate: TestRestTemplate
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>タスク一覧を取得できる</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> header = HttpHeaders()
</span></span><span style=display:flex><span>        header.contentType = <span style=color:#a6e22e>MediaType</span>.APPLICATION_JSON
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> response = restTemplate.exchange(<span style=color:#e6db74>&#34;/todos&#34;</span>, <span style=color:#a6e22e>HttpMethod</span>.GET, HttpEntity(<span style=color:#66d9ef>null</span>, header), String<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> mapper = jacksonObjectMapper()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> articles: List&lt;Todo&gt; = mapper.readValue(response.body<span style=color:#f92672>!!</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Assertions</span>.assertThat(response.statusCode).isEqualTo(<span style=color:#a6e22e>HttpStatus</span>.OK)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Assertions</span>.assertThat(articles.size).isEqualTo(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>最初のテストはこのように書きました。ソフトウェアテストの章でこのあたりは詳しく説明していますので、テストの説明は割愛します。
このテストは当然Todoがまだ定義されてませんのでコンパイルができずに失敗します。</p><h3 id=get-todosの実装-1>GET /todosの実装
<a class=anchor href=#get-todos%e3%81%ae%e5%ae%9f%e8%a3%85-1>#</a></h3><h4 id=modelの実装>Modelの実装
<a class=anchor href=#model%e3%81%ae%e5%ae%9f%e8%a3%85>#</a></h4><p>まず先のテストはTodoモデルが無いことで落ちていたので、これを定義しましょう。</p><p>src/main/kotlin/com.fujitsu.todoappserver配下に<code>model</code>パッケージ、<code>controller</code>パッケージ、<code>service</code>パッケージ、<code>repository</code>パッケージを作りましょう。
そして<code>model</code>パッケージ配下にTodo.ktを作成。</p><pre tabindex=0><code>src
├── main
│     ├── kotlin
│     │     └── com
│     │         └── fujitsu
│     │             └── todoappserver
│     │                 ├── TodoAppServerApplication.kt
│     │                 ├── controller
│     │                 ├── model
│     │                 │     └── Todo.kt       // 作成
│     │                 ├── repository
│     │                 └── service
│     └── resources
│         ├── application.yml
│         ├── db
│         │     └── migration
│         │         └── V20210912045400__CreateTodoTable.sql
│         ├── static
│         └── templates
└── test
    └── kotlin
        └── com
            └── fujitsu
                └── todoappserver
                    ├── TodoAppServerApplicationTests.kt
                    └── controller
                        └── TodoControllerTest.kt
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#75715e>// Todo.kt
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>package</span> com.fujitsu.todoappserver.model
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Todo</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> id: Int,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> title: String,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> completed: Boolean
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>Kotlinはdata classの宣言で簡単にPOJOを作ることができます。Javaだと必要なsetterやgetterは不要です。
このTodoモデルを先ほど作成したテストにインポートして実行してみましょう。</p><p>コンパイルには成功して、Getリクエストが発生していますが、404 Not Foundが返却されるようになりテストが失敗するようになったと思います。</p><h4 id=controller層の実装>Controller層の実装
<a class=anchor href=#controller%e5%b1%a4%e3%81%ae%e5%ae%9f%e8%a3%85>#</a></h4><p>Controller層を実装していきましょう。controllerパッケージ配下にTodoControllerInterface.ktとTodoController.ktを作成します。</p><p>TodoControllerInterfaceにはTodoControllerが使いたい（つまりServiceに実装してもらいたい）メソッドを定義しておきます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#75715e>// TodoControllerInterface.kt
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>package</span> com.fujitsu.todoappserver.controller
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> com.fujitsu.todoappserver.model.Todo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>TodoControllerInterface</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>getTodos</span>(): List&lt;Todo&gt;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>TodoControllerは先程定義したInterfaceを通じてserviceを利用します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#75715e>// TodoController.kt
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>package</span> com.fujitsu.todoappserver.controller
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> com.fujitsu.todoappserver.model.Todo
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.springframework.http.HttpStatus
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.springframework.web.bind.annotation.GetMapping
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.springframework.web.bind.annotation.ResponseStatus
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.springframework.web.bind.annotation.RestController
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TodoController</span>(<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> todoService: TodoControllerInterface) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/todos&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ResponseStatus</span>(<span style=color:#a6e22e>HttpStatus</span>.OK)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>getTodos</span>() : List&lt;Todo&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> todoService.getTodos()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>InterfaceがService層ではなくController層にあるのに違和感を覚える人も多いと思います。
これは依存性逆転の原則(DIP)です。覚えてますでしょうか？
依存性逆転の原則では<strong>抽象の所有権も逆転</strong>させるんでしたよね。</p><h4 id=service層の実装>Service層の実装
<a class=anchor href=#service%e5%b1%a4%e3%81%ae%e5%ae%9f%e8%a3%85>#</a></h4><p>同様にService層も実装していきましょう。Serviceパッケージ配下にTodoServiceInterface.ktとTodoService.ktを作ります。
Service層はRepository層から返ってきたレスポンスをそのままControllerに受け流すだけになるので、説明は割愛します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#75715e>// TodoServiceInterface.kt
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>package</span> com.fujitsu.todoappserver.service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> com.fujitsu.todoappserver.model.Todo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>TodoServiceInterface</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>getTodos</span>(): List&lt;Todo&gt;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#75715e>// TodoService.kt
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>package</span> com.fujitsu.todoappserver.service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> com.fujitsu.todoappserver.controller.TodoControllerInterface
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> com.fujitsu.todoappserver.model.Todo
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.springframework.stereotype.Service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Service</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TodoService</span>(<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> todoRepository: TodoServiceInterface): TodoControllerInterface {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>getTodos</span>(): List&lt;Todo&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> todoRepository.getTodos()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=repository層の実装>Repository層の実装
<a class=anchor href=#repository%e5%b1%a4%e3%81%ae%e5%ae%9f%e8%a3%85>#</a></h4><p>Repository層を実装します。repositoryパッケージ配下にTodoRepository.ktを作成し、TodoServiceInterfaceを実装しましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#75715e>// TodoRepository.kt
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>package</span> com.fujitsu.todoappserver.repository
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> com.fujitsu.todoappserver.model.Todo
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> com.fujitsu.todoappserver.service.TodoServiceInterface
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.springframework.jdbc.core.JdbcTemplate
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> org.springframework.stereotype.Repository
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> java.sql.ResultSet
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Repository</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TodoRepository</span>(<span style=color:#66d9ef>val</span> jdbcTemplate: JdbcTemplate) : TodoServiceInterface {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>getTodos</span>(): List&lt;Todo&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> jdbcTemplate.query(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;&#34;&#34;select id, title, completed from todo&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        ) {rs: ResultSet, _:Int <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>            Todo(rs.getInt(<span style=color:#e6db74>&#34;id&#34;</span>),
</span></span><span style=display:flex><span>                rs.getString(<span style=color:#e6db74>&#34;title&#34;</span>),
</span></span><span style=display:flex><span>                rs.getBoolean(<span style=color:#e6db74>&#34;completed&#34;</span>)
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Repositoryは実際にDBに対してクエリを投げ、ResultSetからTodoオブジェクトを作り、それをListとして返しています。
これで実装は終わりました。テストを実行してみましょう！</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./gradlew test
</span></span></code></pre></div><pre tabindex=0><code>onebase@Onebase-Maguro todo-app-server % ./gradlew test

&gt; Task :test
2021-09-12 06:37:05.404  INFO 76511 --- [ionShutdownHook] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Shutdown initiated...
2021-09-12 06:37:05.408  INFO 76511 --- [ionShutdownHook] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Shutdown completed.

BUILD SUCCESSFUL in 4s
4 actionable tasks: 1 executed, 3 up-to-date
</code></pre><p>テストが通る様子が確認できると思います。</p><h2 id=クライアントとサーバの連携>クライアントとサーバの連携
<a class=anchor href=#%e3%82%af%e3%83%a9%e3%82%a4%e3%82%a2%e3%83%b3%e3%83%88%e3%81%a8%e3%82%b5%e3%83%bc%e3%83%90%e3%81%ae%e9%80%a3%e6%90%ba>#</a></h2><p>さて、サーバを起動した状態にしておいてください。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./gradlew bootRun
</span></span></code></pre></div><p>サーバを起動した状態でクライアントを起動しましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>npm run dev
</span></span></code></pre></div><p>その状態で <a href=http://localhost:5173/>http://localhost:5173/</a> にアクセスすると、構築したサーバへの/todosのGETリクエストは送信されておらず、<br>304が返却されていることが確認できると思います。
<img src=getTodos304.png alt=304></p><p>それもそのはず、Clientはlocalhost:5173/todosにリクエストしている一方で、サーバは8080ポートで起動しているからです。
そこでClientにProxyの設定を入れてあげます。</p><p>Clientの<code>vite.config.ts</code>を開いたら以下の設定を追記して、再度Clientを起動してみましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>defineConfig</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;vite&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>react</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@vitejs/plugin-react&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// https://vite.dev/config/
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>defineConfig</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>plugins</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>react</span>()],
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>server</span><span style=color:#f92672>:</span> {                                    <span style=color:#75715e>// 追記
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>proxy</span><span style=color:#f92672>:</span> {                                   <span style=color:#75715e>// 追記    
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#e6db74>&#34;/todos&#34;</span><span style=color:#f92672>:</span> {                              <span style=color:#75715e>// 追記
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>target</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;http://localhost:8080&#34;</span>,       <span style=color:#75715e>// 追記
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>changeOrigin</span>: <span style=color:#66d9ef>true</span>                     <span style=color:#75715e>// 追記
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      }                                        <span style=color:#75715e>// 追記
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }                                          <span style=color:#75715e>// 追記
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }                                            <span style=color:#75715e>// 追記 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>})
</span></span></code></pre></div><p><img src=getTodos200.png alt=200></p><p>proxyの設定によりServerが応答できるようになり、200が返却されているのが確認できると思います。</p><p>おめでとうございまいます！最初のサーバAPIとクライアントを連携させたアプリケーションを実装することができました！</p><h2 id=に置いてあります>ここまでのソースは
<a href=https://github.com/onebase-fujitsu/todo-app-vite/tree/feature/step6>https://github.com/onebase-fujitsu/todo-app-vite/tree/feature/step6</a>
に置いてあります。
<a class=anchor href=#%e3%81%ab%e7%bd%ae%e3%81%84%e3%81%a6%e3%81%82%e3%82%8a%e3%81%be%e3%81%99>#</a></h2><p>4日目に続きます</p><a href=/agile-dev-guide/docs/practice/day4/ class=book-btn>4日目</a></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#バックエンドの初期設定>バックエンドの初期設定</a><ul><li><a href=#spring-bootのプロジェクト作成>Spring Bootのプロジェクト作成</a></li><li><a href=#dbの設定>DBの設定</a></li><li><a href=#dbのマイグレーションツールの導入>DBのマイグレーションツールの導入</a></li></ul></li><li><a href=#get-todosの実装>GET /todosの実装</a><ul><li><a href=#get-todosのテスト>GET /todosのテスト</a></li><li><a href=#get-todosの実装-1>GET /todosの実装</a></li></ul></li><li><a href=#クライアントとサーバの連携>クライアントとサーバの連携</a></li><li><a href=#に置いてあります>ここまでのソースは
<a href=https://github.com/onebase-fujitsu/todo-app-vite/tree/feature/step6>https://github.com/onebase-fujitsu/todo-app-vite/tree/feature/step6</a>
に置いてあります。</a></li></ul></nav></div></aside></main></body></html>