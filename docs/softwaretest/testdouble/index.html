<!doctype html><html lang=ja dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  テストダブル
  #

テスト駆動開発の開発の流れがわかってきたところで、次にテストダブルを使用したテストについて学んでいきましょう。

  テストダブルとは
  #

テスト対象となるクラスやメソッドが、ほかのクラスに依存していないケースはほとんどありません。
依存しているクラスもまた、ほかのクラスに依存しています。"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://onebase-fujitsu.github.io/agile-dev-guide/docs/softwaretest/testdouble/"><meta property="og:site_name" content="Fujitsu Agile Development Guide"><meta property="og:title" content="テストダブル"><meta property="og:description" content="テストダブル # テスト駆動開発の開発の流れがわかってきたところで、次にテストダブルを使用したテストについて学んでいきましょう。
テストダブルとは # テスト対象となるクラスやメソッドが、ほかのクラスに依存していないケースはほとんどありません。 依存しているクラスもまた、ほかのクラスに依存しています。"><meta property="og:locale" content="ja"><meta property="og:type" content="article"><meta property="article:section" content="docs"><title>テストダブル | Fujitsu Agile Development Guide</title>
<link rel=icon href=/agile-dev-guide/favicon.png><link rel=manifest href=/agile-dev-guide/manifest.json><link rel=canonical href=https://onebase-fujitsu.github.io/agile-dev-guide/docs/softwaretest/testdouble/><link rel=stylesheet href=/agile-dev-guide/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/agile-dev-guide/><span>Fujitsu Agile Development Guide</span></a></h2><ul><li><a href=/agile-dev-guide/docs/introduction/>はじめに</a></li><li><input type=checkbox id=section-fe72557a7878dded4efa0060e21abacc class=toggle>
<label for=section-fe72557a7878dded4efa0060e21abacc class="flex justify-between"><a role=button>アジャイル</a></label><ul><li><a href=/agile-dev-guide/docs/agile/manifest/>アジャイルソフトウェア開発宣言</a></li><li><a href=/agile-dev-guide/docs/agile/principle/>アジャイル開発12の原則</a></li><li><a href=/agile-dev-guide/docs/agile/conclude/>まとめ</a></li></ul></li><li><input type=checkbox id=section-60906829343241fe59efbb09409d99f8 class=toggle>
<label for=section-60906829343241fe59efbb09409d99f8 class="flex justify-between"><a role=button>スクラム</a></label><ul><li><a href=/agile-dev-guide/docs/scrum/overview/>スクラムとは</a></li><li><a href=/agile-dev-guide/docs/scrum/roles/>ロール</a></li><li><a href=/agile-dev-guide/docs/scrum/products/>成果物</a></li><li><a href=/agile-dev-guide/docs/scrum/events/>イベント</a></li><li><a href=/agile-dev-guide/docs/scrum/conclude/>まとめ</a></li></ul></li><li><input type=checkbox id=section-8258873460fa80799dab8ced5b37f178 class=toggle>
<label for=section-8258873460fa80799dab8ced5b37f178 class="flex justify-between"><a role=button>エクストリームプログラミング</a></label><ul><li><a href=/agile-dev-guide/docs/xp/overview/>エクストリームプログラミングとは</a></li><li><a href=/agile-dev-guide/docs/xp/practice/>エクストリームプログラミングのプラクティス</a></li><li><a href=/agile-dev-guide/docs/xp/conclude/>まとめ</a></li></ul></li><li><input type=checkbox id=section-ef522355473a56c6b477dd934de57bb8 class=toggle checked>
<label for=section-ef522355473a56c6b477dd934de57bb8 class="flex justify-between"><a role=button>ソフトウェアテスト</a></label><ul><li><a href=/agile-dev-guide/docs/softwaretest/overview/>ソフトウェアテストを始めよう</a></li><li><a href=/agile-dev-guide/docs/softwaretest/fizzbuzz/>ウォーミングアップ</a></li><li><a href=/agile-dev-guide/docs/softwaretest/bowlinggame/>ボウリングゲーム</a></li><li><a href=/agile-dev-guide/docs/softwaretest/testdouble/ class=active>テストダブル</a></li><li><a href=/agile-dev-guide/docs/softwaretest/e2e/>E2Eテスト</a></li></ul></li><li><input type=checkbox id=section-c09385b1b773ce6e3a59f711992fc86e class=toggle>
<label for=section-c09385b1b773ce6e3a59f711992fc86e class="flex justify-between"><a role=button>ソフトウェア設計</a></label><ul><li><a href=/agile-dev-guide/docs/softwaredesign/about/>アジャイル開発に求められるソフトウェア設計</a></li><li><input type=checkbox id=section-af89c1e488b0f5f376cd7b5e25174bc5 class=toggle>
<label for=section-af89c1e488b0f5f376cd7b5e25174bc5 class="flex justify-between"><a role=button>SOLID原則</a></label><ul><li><a href=/agile-dev-guide/docs/softwaredesign/solidprinciple/srp/>単一責任の原則(SRP)</a></li><li><a href=/agile-dev-guide/docs/softwaredesign/solidprinciple/ocp/>オープン・クローズドの原則(OCP)</a></li><li><a href=/agile-dev-guide/docs/softwaredesign/solidprinciple/lsp/>リスコフの置換原則(LSP)</a></li><li><a href=/agile-dev-guide/docs/softwaredesign/solidprinciple/dip/>依存性逆転の原則(DIP)</a></li><li><a href=/agile-dev-guide/docs/softwaredesign/solidprinciple/isp/>インターフェース分離の原則(ISP)</a></li></ul></li><li><input type=checkbox id=section-866eec1f3dcfccd287cfe06fbdb82bb8 class=toggle>
<label for=section-866eec1f3dcfccd287cfe06fbdb82bb8 class="flex justify-between"><a role=button>デザインパターン</a></label><ul><li><a href=/agile-dev-guide/docs/softwaredesign/designpattern/designpattern/>デザインパターン</a></li></ul></li></ul></li><li><input type=checkbox id=section-ffa226df7ff6fdab04824ed978163e3a class=toggle>
<label for=section-ffa226df7ff6fdab04824ed978163e3a class="flex justify-between"><a role=button>アジャイルの実践</a></label><ul><li><a href=/agile-dev-guide/docs/practice/day1/>1日目</a></li><li><a href=/agile-dev-guide/docs/practice/day2/>2日目</a></li><li><a href=/agile-dev-guide/docs/practice/day3/>3日目</a></li><li><a href=/agile-dev-guide/docs/practice/day4/>4日目</a></li><li><a href=/agile-dev-guide/docs/practice/day5/>5日目</a></li><li><a href=/agile-dev-guide/docs/practice/day6/>6日目</a></li></ul></li><li><a href=/agile-dev-guide/docs/inclosing/>おわりに</a></li><li><a href=/agile-dev-guide/docs/recommendedbooks/>推奨書籍</a></li><li class=book-section-flat><span>全体編</span><ul><li><input type=checkbox id=section-c08c824050a314a836aa6f2a3533d6f4 class=toggle>
<label for=section-c08c824050a314a836aa6f2a3533d6f4 class="flex justify-between"><a role=button>リーンスタートアップアジャイル</a></label><ul><li><a href=/agile-dev-guide/docs/framework/leanstartup/overview/>リーンスタートアップアジャイルの流れ</a></li><li><a href=/agile-dev-guide/docs/framework/leanstartup/organization/>体制・役割</a></li><li><a href=/agile-dev-guide/docs/framework/leanstartup/productvision/>プロダクトビジョン / バリュープロポジション</a></li></ul></li><li><input type=checkbox id=section-4843f470e01d88c8920f705055d62d32 class=toggle>
<label for=section-4843f470e01d88c8920f705055d62d32 class="flex justify-between"><a role=button>モダナイゼーションアジャイル</a></label><ul><li><a href=/agile-dev-guide/docs/framework/modernization/overview/>モダナイゼーションアジャイルの流れ</a></li><li><a href=/agile-dev-guide/docs/framework/modernization/organization/>体制・役割</a></li><li><input type=checkbox id=section-16e7420deaec3bf622c47c912e4fe6b1 class=toggle>
<label for=section-16e7420deaec3bf622c47c912e4fe6b1 class="flex justify-between"><a role=button>Swift Method</a></label><ul><li><a href=/agile-dev-guide/docs/framework/modernization/swift/overview/>Swift Method とは</a></li><li><a href=/agile-dev-guide/docs/framework/modernization/swift/eventstorming/>Event Storming</a></li><li><a href=/agile-dev-guide/docs/framework/modernization/swift/boris/>Boris</a></li><li><a href=/agile-dev-guide/docs/framework/modernization/swift/snape/>SnapE</a></li><li><a href=/agile-dev-guide/docs/framework/modernization/swift/slices/>Slices</a></li><li><a href=/agile-dev-guide/docs/framework/modernization/swift/techchoice/>Tech Choice</a></li></ul></li></ul></li></ul></li><li class=book-section-flat><span>Team編</span><ul><li><a href=/agile-dev-guide/docs/team/workstyle/>チームの働き方</a></li><li><a href=/agile-dev-guide/docs/team/balancedteam/>バランスチーム</a></li><li><input type=checkbox id=section-a232289a72ea66e3aa7212c269a1f858 class=toggle>
<label for=section-a232289a72ea66e3aa7212c269a1f858 class="flex justify-between"><a role=button>マインドセット</a></label><ul><li><a href=/agile-dev-guide/docs/team/mindset/onebase/>ONEbaseの価値観</a></li><li><a href=/agile-dev-guide/docs/team/mindset/psychologicalsafety/>心理的安全性</a></li><li><a href=/agile-dev-guide/docs/team/mindset/xp/>XPの価値観</a></li><li><a href=/agile-dev-guide/docs/team/mindset/practice/>プラクティスの取り入れ方</a></li></ul></li><li><a href=/agile-dev-guide/docs/team/teambuilding/>チームビルディング</a></li><li><a href=/agile-dev-guide/docs/team/remotework/>リモートワーク</a></li><li><input type=checkbox id=section-110f9959d63e8c110b8745fc9d06c772 class=toggle>
<label for=section-110f9959d63e8c110b8745fc9d06c772 class="flex justify-between"><a role=button>チームのアクティビティ</a></label><ul><li><a href=/agile-dev-guide/docs/team/activities/officestandup/>全体スタンドアップ</a></li><li><a href=/agile-dev-guide/docs/team/activities/teamstandup/>チームスタンドアップ</a></li><li><a href=/agile-dev-guide/docs/team/activities/preipm/>Pre-IPM</a></li><li><a href=/agile-dev-guide/docs/team/activities/ipm/>IPM</a></li><li><a href=/agile-dev-guide/docs/team/activities/cl/>CLミーティング</a></li><li><a href=/agile-dev-guide/docs/team/activities/retro/>レトロスペクティブ</a></li><li><a href=/agile-dev-guide/docs/team/activities/salesmeeting/>営業確認会議</a></li><li><a href=/agile-dev-guide/docs/team/activities/internalsync/>Internal Sync</a></li><li><a href=/agile-dev-guide/docs/team/activities/riskmitigations/>Risks & Mitigations</a></li><li><a href=/agile-dev-guide/docs/team/activities/feedback/>フィードバック</a></li><li><a href=/agile-dev-guide/docs/team/activities/icebreak/>Ice Break</a></li><li><a href=/agile-dev-guide/docs/team/activities/teamhealthcheck/>Team Health Check</a></li><li><a href=/agile-dev-guide/docs/team/activities/1on1/>1on1</a></li><li><a href=/agile-dev-guide/docs/team/activities/exercise/>ラジオ体操</a></li></ul></li><li><input type=checkbox id=section-bdb63741ec425eaf58eeca20fa22f0f7 class=toggle>
<label for=section-bdb63741ec425eaf58eeca20fa22f0f7 class="flex justify-between"><a role=button>チームのプラクティス</a></label><ul><li><a href=/agile-dev-guide/docs/team/practices/facilitation/>ファシリテーション</a></li><li><a href=/agile-dev-guide/docs/team/practices/okrs/>OKRs</a></li></ul></li></ul></li><li class=book-section-flat><span>Designer編</span><ul><li><a href=/agile-dev-guide/docs/designer/overview/>Designerとは</a></li><li><input type=checkbox id=section-a01b867896ae9f1f3928ca93b2070a69 class=toggle>
<label for=section-a01b867896ae9f1f3928ca93b2070a69 class="flex justify-between"><a role=button>Designerのプラクティス</a></label><ul><li><a href=/agile-dev-guide/docs/designer/practices/persona/>ペルソナ</a></li><li><a href=/agile-dev-guide/docs/designer/practices/scenario/>シナリオ</a></li><li><a href=/agile-dev-guide/docs/designer/practices/researchplanning/>リサーチ計画立案</a></li><li><a href=/agile-dev-guide/docs/designer/practices/prototyping/>プロトタイピング</a></li><li><a href=/agile-dev-guide/docs/designer/practices/script/>スクリプト作成</a></li><li><a href=/agile-dev-guide/docs/designer/practices/researchaction/>リサーチ実施</a></li><li><a href=/agile-dev-guide/docs/designer/practices/synthesize/>シンセサイズ</a></li></ul></li></ul></li><li class=book-section-flat><span>Product Manager編</span><ul><li><a href=/agile-dev-guide/docs/productmanager/overview/>Product Managerとは</a></li><li><input type=checkbox id=section-d59afdd8070324cbcc7435686b4f2086 class=toggle>
<label for=section-d59afdd8070324cbcc7435686b4f2086 class="flex justify-between"><a role=button>Product Managerのプラクティス</a></label><ul><li><a href=/agile-dev-guide/docs/productmanager/practices/roadmap/>プロダクトロードマップ</a></li><li><a href=/agile-dev-guide/docs/productmanager/practices/mvp/>MVP</a></li><li><a href=/agile-dev-guide/docs/productmanager/practices/userstorymapping/>ユーザーストーリーマッピング</a></li><li><a href=/agile-dev-guide/docs/productmanager/practices/userstory/>ユーザーストーリー</a></li><li><a href=/agile-dev-guide/docs/productmanager/practices/2x2/>2×2</a></li></ul></li></ul></li><li class=book-section-flat><span>Developer編</span><ul><li><a href=/agile-dev-guide/docs/developer/overview/>Developerとは</a></li><li><input type=checkbox id=section-efb8318f4d88b390e60e256084f8f4ac class=toggle>
<label for=section-efb8318f4d88b390e60e256084f8f4ac class="flex justify-between"><a role=button>Developerのプラクティス</a></label><ul><li><a href=/agile-dev-guide/docs/developer/practices/tdd/>TDD</a></li><li><a href=/agile-dev-guide/docs/developer/practices/cicd/>CI/CD</a></li><li><a href=/agile-dev-guide/docs/developer/practices/pairprogramming/>ペアプログラミング</a></li><li><a href=/agile-dev-guide/docs/developer/practices/soroprogramming/>ソロプログラミング</a></li></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/agile-dev-guide/svg/menu.svg class=book-icon alt=Menu></label><h3>テストダブル</h3><label for=toc-control><img src=/agile-dev-guide/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#テストダブルとは>テストダブルとは</a></li><li><a href=#テストダブルを実現するライブラリ>テストダブルを実現するライブラリ</a></li><li><a href=#サンプルアプリケーション>サンプルアプリケーション</a></li><li><a href=#mockitoを使ったcontrollerのユニットテスト>Mockitoを使ったControllerのユニットテスト</a><ul><li><a href=#バックエンドの構造>バックエンドの構造</a></li><li><a href=#最初のテスト>最初のテスト</a></li><li><a href=#2番目のテスト>2番目のテスト</a></li><li><a href=#例外のテスト>例外のテスト</a></li><li><a href=#引数のテスト>引数のテスト</a></li><li><a href=#完成したテスト>完成したテスト</a></li></ul></li><li><a href=#mockitoを使ったインテグレーションテスト>Mockitoを使ったインテグレーションテスト</a><ul><li><a href=#最初のテスト-1>最初のテスト</a></li><li><a href=#2番目のテスト-1>2番目のテスト</a></li><li><a href=#時間を予測可能にする>時間を予測可能にする</a></li><li><a href=#時間をコントロールする>時間をコントロールする</a></li><li><a href=#例外のテスト-1>例外のテスト</a></li><li><a href=#完成したテスト-1>完成したテスト</a></li></ul></li><li><a href=#テスト駆動開発とユニットテストインテグレーションテスト>テスト駆動開発とユニットテスト・インテグレーションテスト</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=テストダブル>テストダブル
<a class=anchor href=#%e3%83%86%e3%82%b9%e3%83%88%e3%83%80%e3%83%96%e3%83%ab>#</a></h1><p>テスト駆動開発の開発の流れがわかってきたところで、次にテストダブルを使用したテストについて学んでいきましょう。</p><h2 id=テストダブルとは>テストダブルとは
<a class=anchor href=#%e3%83%86%e3%82%b9%e3%83%88%e3%83%80%e3%83%96%e3%83%ab%e3%81%a8%e3%81%af>#</a></h2><p>テスト対象となるクラスやメソッドが、ほかのクラスに依存していないケースはほとんどありません。
依存しているクラスもまた、ほかのクラスに依存しています。</p><p>ソフトウェアは多数のクラスが依存し合って動作するため、クラス単体の動作を保証するよりも、ソフトウェア全体の動作を保証するほうが価値が高くなります。
一方、テスト対象クラス以外の問題を原因として、ユニットテストが失敗する可能性があることは大きなデメリットです。</p><p>テストが失敗したときには、最初にテスト対象クラスに問題があると考えるため、原因の分析に余計な時間がかかります。
また、依存する機能が外部サービスや乱数、システム時間など、期待する結果を予測できない場合には検証の精度を落とさざるを得ません。</p><p>そこで、依存する機能がユニットテストで扱いづらい場合や、ユニットテストの独立性を高めたい場合には、依存するオブジェクトを「代役」で置き換える方法が有効です。
この代役となるオブジェクトはスタブやモックとして知られ、総称してテストダブル（TestDouble）と呼ばれます。</p><p>テストダブルには様々なパターンがあります</p><table><thead><tr><th style=text-align:left>テストダブル</th><th style=text-align:left>役割</th><th style=text-align:left>具体例</th></tr></thead><tbody><tr><td style=text-align:left>Stub</td><td style=text-align:left>テスト対象の依存オブジェクトに予測可能な振る舞いをする</td><td style=text-align:left>依存コンポーネントから取得できる値が変化したとき、テスト対象の挙動がどう変化するか確認するテスト</td></tr><tr><td style=text-align:left>Spy</td><td style=text-align:left>テスト対象から依存オブジェクトへの呼び出しを監視する</td><td style=text-align:left>テスト対象が既に実装された依存コンポーネントを呼び出した値や回数を検証するテスト</td></tr><tr><td style=text-align:left>Mock</td><td style=text-align:left>テスト対象から依存オブジェクトへの呼び出しを検証する</td><td style=text-align:left>テスト対象が依存コンポーネントに入力した内容を検証するテスト</td></tr><tr><td style=text-align:left>Fake</td><td style=text-align:left>テストの範囲内で本物と同じように動作する</td><td style=text-align:left>データベースを使用するテストの場合、膨大な時間がかかる場合がある。フェイクとして同機能をインメモリデータベースで実装しテストを高速化する。</td></tr><tr><td style=text-align:left>Dummy</td><td style=text-align:left>内部のパラメータや状態がなんであってもテストに影響を及ぼさない代替オブジェクト</td><td style=text-align:left>テストに関係はないがコンストラクタに与える値が足りない、その値を埋めるために作成する。</td></tr></tbody></table><h2 id=テストダブルを実現するライブラリ>テストダブルを実現するライブラリ
<a class=anchor href=#%e3%83%86%e3%82%b9%e3%83%88%e3%83%80%e3%83%96%e3%83%ab%e3%82%92%e5%ae%9f%e7%8f%be%e3%81%99%e3%82%8b%e3%83%a9%e3%82%a4%e3%83%96%e3%83%a9%e3%83%aa>#</a></h2><p>テストダブルを実現するライブラリも様々なものがあります。
Javaですと <a href=https://site.mockito.org/>Mockito</a>、 <a href=https://easymock.org/>EasyMock</a> 、
<a href=http://jmock.org/>jMock</a> あたりでしょうか。
Javascriptだと <a href=https://sinonjs.org/>Sinon.js</a> や <a href=https://github.com/testdouble/testdouble.js/>testdouble.js</a> が有名です。</p><h2 id=サンプルアプリケーション>サンプルアプリケーション
<a class=anchor href=#%e3%82%b5%e3%83%b3%e3%83%97%e3%83%ab%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3>#</a></h2><p>さて、ここからは具体的なアプリケーションをつかってテストの実装をやってみましょう。</p><p>サンプルアプリケーションは <a href=https://github.com/Onebase-Fujitsu/simple-todo-app>ここ</a> で公開してあります。</p><p><a href=https://github.com/Onebase-Fujitsu/simple-todo-app>https://github.com/Onebase-Fujitsu/simple-todo-app</a></p><p>まずはリポジトリをローカルにCloneしてみましょう。
CloneしたらTerminalを2つ立ち上げて、フロントエンドとバックエンドを起動してみてください。
実行にはJavaの実行環境と、Node.jsの実行環境が必要です。</p><p>リポジトリのClone</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git clone https://github.com/Onebase-Fujitsu/simple-todo-app.git
</span></span></code></pre></div><p>フロントエンドの起動(Mac/Linuxの場合)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cd client
</span></span><span style=display:flex><span>npm install
</span></span><span style=display:flex><span>npm run start
</span></span></code></pre></div><p>フロントエンドの起動(Windowsの場合)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>chdir client
</span></span><span style=display:flex><span>npm install
</span></span><span style=display:flex><span>npm run start
</span></span></code></pre></div><p>バックエンドの起動(Mac/Linuxの場合)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cd sever
</span></span><span style=display:flex><span>SERVER_PORT<span style=color:#f92672>=</span><span style=color:#ae81ff>8080</span> ./gradlew bootRun
</span></span></code></pre></div><p>バックエンドの起動(Windowsの場合)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>chdir server
</span></span><span style=display:flex><span>SERVER_PORT<span style=color:#f92672>=</span><span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>gradlew.bat bootRun
</span></span></code></pre></div><p>まずは、このアプリケーションを動かしてみましょう。このアプリケーションはシンプルなToDo管理アプリケーションです。
Clientは <a href=https://ja.reactjs.org/>React</a> で作っていて、開発言語に <a href=https://www.typescriptlang.org/>Typescript</a> を使用しています。
またUIライブラリに <a href=https://material-ui.com/>Material-UI</a> を採用しています。</p><p>Serverは <a href=https://spring.io/>Spring Boot</a> で作っており、開発言語は <a href=https://www.java.com/ja/>Java</a> です。
DBは <a href=https://www.h2database.com/html/main.html>H2 Database</a> を組み込んでいてインメモリで動かしています。
またDBのマイグレーションツールの <a href=https://flywaydb.org/>Flyway</a> を使用しているのが一つポイントです。またDBをインメモリで動かしてますので、Serverアプリケーションを終了する度にデータは揮発します。</p><p>ServerとClientを起動した状態で、Webブラウザで <a href=http://localhost:3000>http://localhost:3000</a> にアクセスするとこのような画面が表示されるはずです。</p><p><img src=sampleApp1.jpg alt=SampleTodoApp1></p><p>タスク名や説明を入力してSaveをクリックすると、タスクが保存されますし、
ブラウザをリロードしても状態が保存されていることがわかると思います。</p><p><img src=sampleApp2.jpg alt=SampleTodoApp2></p><p>タスクを完了したり、ゴミ箱ボタンをクリックすると削除したりすることができます。</p><p>ServerのAPIの仕様は <a href=https://swagger.io/specification/>OpenAPI Specification(OAS) 3.0</a> で公開してあります。
OASはAPIの標準仕様で以前はSwaggerという名前で呼ばれていたので、そちらのほうが馴染みある方も多いかもしれません。</p><p>Serverを起動した状態で <a href=http://localhost:8080/v3/api-docs>http://localhost:8080/v3/api-docs</a> にアクセスするとOAS3.0の仕様を取得できます。
また、このServerはSwagger UIも提供しているため <a href=http://localhost:8080/swagger-ui/>http://localhost:8080/swagger-ui/</a> にアクセスするとGUIで仕様を確かめたり、APIを実際に叩いてみたりすることができます。</p><p><img src=swagger.jpg alt=Swagger></p><p>また、DBはServerを起動した状態で <a href=http://localhost:8080/h2-console>http://localhost:8080/h2-console/</a> にアクセスするとログイン用のコンソールが表示されます。</p><p><img src=h2Console.jpg alt=H2Console></p><p>実環境用のDBは<code>jdbc:h2:mem:todo_db</code>で、User名は<code>sa</code>、パスワードはなしでDBに接続できます。
テスト中のDBの状態を確認したい場合は、任意の箇所にブレークポイントを設定して、<code>jdbc:h2:mem:todo_test_db</code>に接続してみましょう。
コンソールにログインしたら任意のSQLを実行できる画面が表示されます。
組み込みのインメモリで動かしている関係でこの方法でしかDBの状態を確認する方法がありませんので、気をつけてください。</p><p>さて、<a href=https://github.com/Onebase-Fujitsu/simple-todo-app/tree/main/server/src/test>ここの配下</a> を見てもらえると分かりますが、このアプリケーションにはテストが実装されていません。
ということで一緒にハンズオン形式でテストを実装してみましょう。</p><h2 id=mockitoを使ったcontrollerのユニットテスト>Mockitoを使ったControllerのユニットテスト
<a class=anchor href=#mockito%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%9fcontroller%e3%81%ae%e3%83%a6%e3%83%8b%e3%83%83%e3%83%88%e3%83%86%e3%82%b9%e3%83%88>#</a></h2><p>Spring Bootアプリケーションを新規に作るときは <a href=https://start.spring.io/>spring initializr</a> を使うんですが、
テストのために必要な様々なライブラリはデフォルトでついてきます。</p><p><a href=https://github.com/Onebase-Fujitsu/simple-todo-app/blob/main/server/build.gradle>build.gradle</a>
を見ると以下のような設定パラメータを見ることができます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gradle data-lang=gradle><span style=display:flex><span>dependencies <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	implementation <span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter-jdbc:2.5.3&#39;</span>
</span></span><span style=display:flex><span>	implementation <span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter-web:2.5.3&#39;</span>
</span></span><span style=display:flex><span>	implementation <span style=color:#e6db74>&#39;com.h2database:h2:1.4.200&#39;</span>
</span></span><span style=display:flex><span>	implementation <span style=color:#e6db74>&#39;org.flywaydb:flyway-core:7.12.1&#39;</span>
</span></span><span style=display:flex><span>	implementation <span style=color:#e6db74>&#39;io.springfox:springfox-boot-starter:3.0.0&#39;</span>
</span></span><span style=display:flex><span>	testImplementation <span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter-test:2.5.3&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>この中の<code>testImplementation 'org.springframework.boot:spring-boot-starter-test:2.5.3'</code>がSpring Bootアプリケーションに必要な様々な機能を提供しているライブラリです。
テストダブルを使ったテストを実現するライブラリ<code>Mockito</code>もこの中に含まれています。</p><h3 id=バックエンドの構造>バックエンドの構造
<a class=anchor href=#%e3%83%90%e3%83%83%e3%82%af%e3%82%a8%e3%83%b3%e3%83%89%e3%81%ae%e6%a7%8b%e9%80%a0>#</a></h3><p>さて、次にバックエンドの作りを見てみましょう。
バックエンドは極々一般的な3層アーキテクチャになっています。</p><script src=/agile-dev-guide/mermaid.min.js></script><script>mermaid.initialize({flowchart:{useMaxWidth:!0},theme:"default"})</script><pre class=mermaid>
classDiagram
class TodoAppController{
  TodoAppService todoAppService
  getAllTasks() List~Task~
  createTask(NewTask newTask) void
  finishTask(int taskId) void
  revertTask(int taskId) void
  deleteTask(int taskId) void
}
class TodoAppControllerInterface{
  getAllTasks() List~Task~
  createTask(NewTask newTask) void
  finishTask(int taskId) void
  revertTask(int taskId) void
  deleteTask(int taskId) void
}
class TodoAppService{
  TodoAppRepository todoAppRepository
  ClockService clockService
  getAllTasks() List~Task~
  createTask(NewTask newTask) void
  finishTask(int taskId) void
  revertTask(int taskId) void
  deleteTask(int taskId) void
}
class TodoAppServiceInterface{
getAllTasks() List~Task~
createTask(NewTask newTask, Instant now) void
finishTask(int taskId, Instant now) void
revertTask(int taskId, Instant now) void
deleteTask(int taskId, Instant now) void
}
class TodoAppRepository{
  JdbcTemplate jdbcTemplate
  getAllTasks() List~Task~
  createTask(NewTask newTask, Instant now) void
  finishTask(int taskId, Instant now) void
  revertTask(int taskId, Instant now) void
  deleteTask(int taskId, Instant now) void
}
class ClockServiceInterface{
  now() Instant
}
class ClockService{
  now() Instant
}
TodoAppController ..> TodoAppControllerInterface
TodoAppService ..|> TodoAppControllerInterface
TodoAppService ..> TodoAppServiceInterface
TodoAppRepository ..|> TodoAppServiceInterface
TodoAppService ..> ClockServiceInterface
ClockService ..|> ClockServiceInterface
</pre><p>TodoAppControllerはTodoAppControllerInterfaceに依存していて、TodoAppServiceはTodoAppServiceInterfaceに依存しています。
そしてTodoAppServiceがTodoAppControllerInterfaceの実装をしており、同様にTodoAppRepositoryがTodoAppServiceInterfaceの実装をしています。
これは <a href=https://onebase-fujitsu.github.io/agile-dev-guide/docs/softwaredesign/solidprinciple/dip/>依存性逆転の原則(DIP)</a> に従ったものです。
抽象に依存するようにして結合度を下げています。これについては後述します。</p><p>また、TodoAppServiceはClockServiceInterfaceにも依存しています。now()は現在時刻を返す実装になっています。
Controllerの各メソッドは対応するServiceのメソッドを呼び出し、now()で現在時刻を取得して、DBの更新処理をよびだすという作りになっています。</p><h3 id=最初のテスト>最初のテスト
<a class=anchor href=#%e6%9c%80%e5%88%9d%e3%81%ae%e3%83%86%e3%82%b9%e3%83%88>#</a></h3><p>では早速getAllTask()のテストを書いていきましょう。
getAllTasks()はタスクを全件取得するメソッドです。
まずはタスクが0件のときに空の配列を返すということを確認するテストを書いていきましょう。</p><p><code>server\src\test\java\com.example.todoApp</code>配下に<code>controller</code>パッケージを新規に作成し<code>TodoAppControllerUnitTest.java</code>を作りましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// TodoAppControllerUnitTest.java</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> com.example.todoApp.controller;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.Test;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.extension.ExtendWith;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.test.context.junit.jupiter.SpringExtension;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ExtendWith</span>(SpringExtension.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TodoAppControllerUnitTest</span> {
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>まずは雛形。
<code>@ExtendWith(SpringExtension.class)</code>という見慣れない記述がありますが、これはJUnit5上でSpring TestContext Frameworkを使用できるようにしているクラスです。
最初はおまじないだと思ってください。</p><p>さて、実際のプロダクトの実装ではServiceは実装されているのですが、ここで実装したいのはControllerの単体テストです。
ちゃんとControllerがServiceを呼んでいるよねという確認や、Serviceからの戻り値に応じた返却をしているよねという検証をしたいです。
ということで、ここでは本物のTodoAppServiceではなく、Serviceの代わりに成り代わって呼び出しの検証や、戻り値を設定できるオブジェクトを使ったテストがしたいです。</p><p>そこで使われるのが <strong>依存性注入(Dependency Injection)</strong> という仕組みです。よくDIと言われます。
文字通り依存しているオブジェクトを注入する仕組みです。</p><p>百聞は一見にしかずといいますので、まずは以下のコードを書いてみてください。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// TodoAppControllerUnitTest.java</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> com.example.todoApp.controller;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.Test;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.extension.ExtendWith;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.mockito.InjectMocks;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.mockito.Mock;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.test.context.junit.jupiter.SpringExtension;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ExtendWith</span>(SpringExtension.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TodoAppControllerUnitTest</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Mock</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TodoAppControllerInterface appService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@InjectMocks</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TodoAppController appController;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>@Mock</code>と<code>@InjectMocks</code>というアノテーションが出てきました。
これは共にMockitoの機能になります。</p><p><code>@Mock</code>はモックオブジェクトを作る宣言です。
ここではTodoAppServiceのモックを作っています。</p><p><code>@InjectMocks</code>は<code>@Mock</code>で作成したモックオブジェクトを注入する対象です。
ですので、上の記述はTodoAppControllerInterfaceのモックインスタンス<code>appService</code>を注入したTodoAppControllerクラスのインスタンス、<code>appController</code>を作成しています。</p><p>ではこれでどういう事ができるか実際にテストを書いてみましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// TodoAppControllerUnitTest.java</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> com.example.todoApp.controller;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.example.todoApp.model.Task;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.Test;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.extension.ExtendWith;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.mockito.InjectMocks;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.mockito.Mock;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.test.context.junit.jupiter.SpringExtension;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Collections;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.List;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.assertj.core.api.AssertionsForClassTypes.assertThat;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.mockito.Mockito.*;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ExtendWith</span>(SpringExtension.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TodoAppControllerUnitTest</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Mock</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TodoAppControllerInterface appService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@InjectMocks</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TodoAppController appController;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>タスクが取得できなかったら空のタスクリストを返す</span>() {
</span></span><span style=display:flex><span>    when(appService.<span style=color:#a6e22e>getAllTasks</span>()).<span style=color:#a6e22e>thenReturn</span>(Collections.<span style=color:#a6e22e>emptyList</span>());
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>&gt;</span> tasks <span style=color:#f92672>=</span> appController.<span style=color:#a6e22e>getAllTasks</span>();
</span></span><span style=display:flex><span>    verify(appService, times(1)).<span style=color:#a6e22e>getAllTasks</span>();
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>size</span>()).<span style=color:#a6e22e>isEqualTo</span>(0);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>最初のテストができました。このテストはもうパスするのですが（実装終わってるので当たり前ですね&mldr;）、1行づつ解説していきます。</p><p>まず、<code>when(appService.getAllTasks()).thenReturn(Collections.emptyList());</code>という記述がでてきました。
これはMockしているappServiceインスタンスのgeAllTasks()メソッドをが呼ばれたときに、何の値を返すかを設定しています。
ここではgetAllTasks()が呼ばれたらからの配列を返すよと宣言しています。</p><p>準備が終わったので、実際にappControllerのgetAllTasks()をその次の行で呼んでますね。</p><p>次に<code>verify(appService, times(1)).getAllTasks();</code>という処理が出てきました。
これはappServiceのgetAllTasks()が1回呼ばれていることを検証する処理です。
実装を見るとわかるのですが、TodoAppControllerのgetAllTasks()ではTodoAppServiceのgetAllTasks()を一回だけ呼び出してその返却値を返すという単純な処理になっています。
もし複数回appServiceのgetAllTasks()が呼ばれているとおかしいですよね。
verifyを使うことで呼ばれた回数を検証することができます。</p><p>最後にassertThatでappControllerの戻り値を確認してます。Mockオブジェクトが空の配列を返すように設定しましたが、
その設定通り空の配列が返ってきていることをここで検証できます。</p><p>こうしたMockitoを使った単体テストを書くと、<strong>高速で再現性の高いテストを書くことができます。</strong>
例えば実際のプロダクトコードを使ってしまうと、DB直接アクセスしてしまって、
実際のDBの状態に影響されてしまいます。</p><p>でもモックを使って依存するオブジェクトをモッキングしてしまえば、戻り値もなにもかもテストでコントロールできるわけです！</p><h3 id=2番目のテスト>2番目のテスト
<a class=anchor href=#2%e7%95%aa%e7%9b%ae%e3%81%ae%e3%83%86%e3%82%b9%e3%83%88>#</a></h3><p>では本当にモックは戻り値を予測可能な振る舞いにしているかどうかをもう一つテストを書いてみましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// TodoAppControllerUnitTest.java</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> com.example.todoApp.controller;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.example.todoApp.model.Task;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.Test;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.extension.ExtendWith;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.mockito.InjectMocks;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.mockito.Mock;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.test.context.junit.jupiter.SpringExtension;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.time.OffsetDateTime;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Collections;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.List;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.assertj.core.api.AssertionsForClassTypes.assertThat;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.mockito.Mockito.*;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ExtendWith</span>(SpringExtension.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TodoAppControllerUnitTest</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Mock</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TodoAppControllerInterface appService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@InjectMocks</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TodoAppController appController;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>タスクが取得できなかったら空のタスクリストを返す</span>() {
</span></span><span style=display:flex><span>    when(appService.<span style=color:#a6e22e>getAllTasks</span>()).<span style=color:#a6e22e>thenReturn</span>(Collections.<span style=color:#a6e22e>emptyList</span>());
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>&gt;</span> tasks <span style=color:#f92672>=</span> appController.<span style=color:#a6e22e>getAllTasks</span>();
</span></span><span style=display:flex><span>    verify(appService, times(1)).<span style=color:#a6e22e>getAllTasks</span>();
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>size</span>()).<span style=color:#a6e22e>isEqualTo</span>(0);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>複数のタスクをリストで返す</span>() {
</span></span><span style=display:flex><span>    when(appService.<span style=color:#a6e22e>getAllTasks</span>()).<span style=color:#a6e22e>thenReturn</span>(List.<span style=color:#a6e22e>of</span>(
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> Task(1, <span style=color:#e6db74>&#34;hoge&#34;</span>, <span style=color:#e6db74>&#34;fuga&#34;</span>, <span style=color:#66d9ef>false</span>, OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-19T15:00:00+09:00&#34;</span>), OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-19T16:00:00+09:00&#34;</span>)),
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> Task(2, <span style=color:#e6db74>&#34;foo&#34;</span>, <span style=color:#e6db74>&#34;bar&#34;</span>, <span style=color:#66d9ef>true</span>, OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-20T15:00:00+09:00&#34;</span>), OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-20T16:00:00+09:00&#34;</span>))));
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>&gt;</span> tasks <span style=color:#f92672>=</span> appController.<span style=color:#a6e22e>getAllTasks</span>();
</span></span><span style=display:flex><span>    verify(appService, times(1)).<span style=color:#a6e22e>getAllTasks</span>();
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>size</span>()).<span style=color:#a6e22e>isEqualTo</span>(2);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>title</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;hoge&#34;</span>);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>description</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;fuga&#34;</span>);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>isDone</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>createdAt</span>).<span style=color:#a6e22e>isEqualTo</span>(OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-19T15:00:00+09:00&#34;</span>));
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>updatedAt</span>).<span style=color:#a6e22e>isEqualTo</span>(OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-19T16:00:00+09:00&#34;</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(1).<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>isEqualTo</span>(2);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(1).<span style=color:#a6e22e>title</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(1).<span style=color:#a6e22e>description</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(1).<span style=color:#a6e22e>isDone</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(1).<span style=color:#a6e22e>createdAt</span>).<span style=color:#a6e22e>isEqualTo</span>(OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-20T15:00:00+09:00&#34;</span>));
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(1).<span style=color:#a6e22e>updatedAt</span>).<span style=color:#a6e22e>isEqualTo</span>(OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-20T16:00:00+09:00&#34;</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>2つ目のテストを書きました。ちょっと長いですがやってることは1つ目のテストと大して変わりません。
1行目でappServiceのgetAllTasks()メソッドが2件のTaskインスタンスのリストを返すようにしています。
このテスト動かしてみるとちゃんとパスすることが確認できるでしょう。テストで戻り値をコントロールできていることが分かりますね。</p><h3 id=例外のテスト>例外のテスト
<a class=anchor href=#%e4%be%8b%e5%a4%96%e3%81%ae%e3%83%86%e3%82%b9%e3%83%88>#</a></h3><p>TodoAppControllerのgetAllTasks()ではDBアクセスに失敗したときに例外をスローするようにしています。
MockitoやJUnitを使わない場合、このような例外のテストは非常に大変です。
実際に異常が発生する状況を再現してテストをする必要がありますし、そもそもそういった状況を再現することすら難しい場合も多くあります。</p><p>これもMockitoを使うと簡単に例外を発生させることができますし、また検査対象が例外をスローしたことを検証することも簡単にできます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// TodoAppControllerUnitTest.java</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> com.example.todoApp.controller;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.example.todoApp.model.Task;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.Test;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.extension.ExtendWith;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.mockito.InjectMocks;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.mockito.Mock;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.dao.DataAccessException;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.test.context.junit.jupiter.SpringExtension;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.server.ResponseStatusException;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.time.OffsetDateTime;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Collections;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.List;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.assertj.core.api.AssertionsForClassTypes.assertThat;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.junit.jupiter.api.Assertions.assertThrows;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.mockito.Mockito.*;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ExtendWith</span>(SpringExtension.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TodoAppControllerUnitTest</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Mock</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TodoAppControllerInterface appService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@InjectMocks</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TodoAppController appController;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>タスクが取得できなかったら空のタスクリストを返す</span>() {
</span></span><span style=display:flex><span>    when(appService.<span style=color:#a6e22e>getAllTasks</span>()).<span style=color:#a6e22e>thenReturn</span>(Collections.<span style=color:#a6e22e>emptyList</span>());
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>&gt;</span> tasks <span style=color:#f92672>=</span> appController.<span style=color:#a6e22e>getAllTasks</span>();
</span></span><span style=display:flex><span>    verify(appService, times(1)).<span style=color:#a6e22e>getAllTasks</span>();
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>size</span>()).<span style=color:#a6e22e>isEqualTo</span>(0);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>複数のタスクをリストで返す</span>() {
</span></span><span style=display:flex><span>    when(appService.<span style=color:#a6e22e>getAllTasks</span>()).<span style=color:#a6e22e>thenReturn</span>(List.<span style=color:#a6e22e>of</span>(
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> Task(1, <span style=color:#e6db74>&#34;hoge&#34;</span>, <span style=color:#e6db74>&#34;fuga&#34;</span>, <span style=color:#66d9ef>false</span>, OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-19T15:00:00+09:00&#34;</span>), OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-19T16:00:00+09:00&#34;</span>)),
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> Task(2, <span style=color:#e6db74>&#34;foo&#34;</span>, <span style=color:#e6db74>&#34;bar&#34;</span>, <span style=color:#66d9ef>true</span>, OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-20T15:00:00+09:00&#34;</span>), OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-20T16:00:00+09:00&#34;</span>))));
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>&gt;</span> tasks <span style=color:#f92672>=</span> appController.<span style=color:#a6e22e>getAllTasks</span>();
</span></span><span style=display:flex><span>    verify(appService, times(1)).<span style=color:#a6e22e>getAllTasks</span>();
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>size</span>()).<span style=color:#a6e22e>isEqualTo</span>(2);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>title</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;hoge&#34;</span>);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>description</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;fuga&#34;</span>);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>isDone</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>createdAt</span>).<span style=color:#a6e22e>isEqualTo</span>(OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-19T15:00:00+09:00&#34;</span>));
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>updatedAt</span>).<span style=color:#a6e22e>isEqualTo</span>(OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-19T16:00:00+09:00&#34;</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(1).<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>isEqualTo</span>(2);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(1).<span style=color:#a6e22e>title</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(1).<span style=color:#a6e22e>description</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(1).<span style=color:#a6e22e>isDone</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(1).<span style=color:#a6e22e>createdAt</span>).<span style=color:#a6e22e>isEqualTo</span>(OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-20T15:00:00+09:00&#34;</span>));
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(1).<span style=color:#a6e22e>updatedAt</span>).<span style=color:#a6e22e>isEqualTo</span>(OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-20T16:00:00+09:00&#34;</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>DBアクセスエラーを検知したときResponseStatusExceptionを投げる</span>() {
</span></span><span style=display:flex><span>    when(appService.<span style=color:#a6e22e>getAllTasks</span>()).<span style=color:#a6e22e>thenThrow</span>(<span style=color:#66d9ef>new</span> DataAccessException(<span style=color:#e6db74>&#34;...&#34;</span>){ });
</span></span><span style=display:flex><span>    assertThrows(ResponseStatusException.<span style=color:#a6e22e>class</span>, () <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>      appController.<span style=color:#a6e22e>getAllTasks</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>最後に1件テストを追加しました。
<code>when(appService.getAllTasks()).thenThrow(new DataAccessException("..."){ });</code>
appServiceのgetAllTasks()というメソッドが呼ばれたときに、DataAccessException例外をスローしなさいと宣言してます。
それを検証しているのが<code>assertThrows()</code>です。appControllerのgetAllTasks()を呼んだときにResponseStatusExceptionがスローされているかどうかを検証しています。</p><p>例外も思うどおりコントロールできていることがわかるでしょう。</p><h3 id=引数のテスト>引数のテスト
<a class=anchor href=#%e5%bc%95%e6%95%b0%e3%81%ae%e3%83%86%e3%82%b9%e3%83%88>#</a></h3><p>TodoAppControllerInterfaceのgetAllTasks()はパラメータがなかったですが、その他のメソッドには引数が必要です。
Controllerが引数を正しくセットしてServiceのメソッドを呼んでいるかの検証もできます。</p><p>引数の検証にはCaptorを使います。実際にテストを書いてみましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// TodoAppControllerUnitTest.java</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> com.example.todoApp.controller;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.example.todoApp.model.NewTask;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.example.todoApp.model.Task;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.Test;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.extension.ExtendWith;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.mockito.ArgumentCaptor;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.mockito.Captor;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.mockito.InjectMocks;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.mockito.Mock;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.dao.DataAccessException;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.test.context.junit.jupiter.SpringExtension;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.server.ResponseStatusException;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.time.OffsetDateTime;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Collections;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.List;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.assertj.core.api.AssertionsForClassTypes.assertThat;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.junit.jupiter.api.Assertions.assertThrows;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.mockito.Mockito.*;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ExtendWith</span>(SpringExtension.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TodoAppControllerUnitTest</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Mock</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TodoAppControllerInterface appService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@InjectMocks</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TodoAppController appController;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Captor</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> ArgumentCaptor<span style=color:#f92672>&lt;</span>NewTask<span style=color:#f92672>&gt;</span> argCaptor;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>タスクが取得できなかったら空のタスクリストを返す</span>() {
</span></span><span style=display:flex><span>    when(appService.<span style=color:#a6e22e>getAllTasks</span>()).<span style=color:#a6e22e>thenReturn</span>(Collections.<span style=color:#a6e22e>emptyList</span>());
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>&gt;</span> tasks <span style=color:#f92672>=</span> appController.<span style=color:#a6e22e>getAllTasks</span>();
</span></span><span style=display:flex><span>    verify(appService, times(1)).<span style=color:#a6e22e>getAllTasks</span>();
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>size</span>()).<span style=color:#a6e22e>isEqualTo</span>(0);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>複数のタスクをリストで返す</span>() {
</span></span><span style=display:flex><span>    when(appService.<span style=color:#a6e22e>getAllTasks</span>()).<span style=color:#a6e22e>thenReturn</span>(List.<span style=color:#a6e22e>of</span>(
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> Task(1, <span style=color:#e6db74>&#34;hoge&#34;</span>, <span style=color:#e6db74>&#34;fuga&#34;</span>, <span style=color:#66d9ef>false</span>, OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-19T15:00:00+09:00&#34;</span>), OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-19T16:00:00+09:00&#34;</span>)),
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> Task(2, <span style=color:#e6db74>&#34;foo&#34;</span>, <span style=color:#e6db74>&#34;bar&#34;</span>, <span style=color:#66d9ef>true</span>, OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-20T15:00:00+09:00&#34;</span>), OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-20T16:00:00+09:00&#34;</span>))));
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>&gt;</span> tasks <span style=color:#f92672>=</span> appController.<span style=color:#a6e22e>getAllTasks</span>();
</span></span><span style=display:flex><span>    verify(appService, times(1)).<span style=color:#a6e22e>getAllTasks</span>();
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>size</span>()).<span style=color:#a6e22e>isEqualTo</span>(2);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>title</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;hoge&#34;</span>);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>description</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;fuga&#34;</span>);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>isDone</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>createdAt</span>).<span style=color:#a6e22e>isEqualTo</span>(OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-19T15:00:00+09:00&#34;</span>));
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(0).<span style=color:#a6e22e>updatedAt</span>).<span style=color:#a6e22e>isEqualTo</span>(OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-19T16:00:00+09:00&#34;</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(1).<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>isEqualTo</span>(2);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(1).<span style=color:#a6e22e>title</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(1).<span style=color:#a6e22e>description</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(1).<span style=color:#a6e22e>isDone</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(1).<span style=color:#a6e22e>createdAt</span>).<span style=color:#a6e22e>isEqualTo</span>(OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-20T15:00:00+09:00&#34;</span>));
</span></span><span style=display:flex><span>    assertThat(tasks.<span style=color:#a6e22e>get</span>(1).<span style=color:#a6e22e>updatedAt</span>).<span style=color:#a6e22e>isEqualTo</span>(OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-20T16:00:00+09:00&#34;</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>DBアクセスエラーを検知したときResponseStatusExceptionを投げる</span>() {
</span></span><span style=display:flex><span>    when(appService.<span style=color:#a6e22e>getAllTasks</span>()).<span style=color:#a6e22e>thenThrow</span>(<span style=color:#66d9ef>new</span> DataAccessException(<span style=color:#e6db74>&#34;...&#34;</span>){ });
</span></span><span style=display:flex><span>    assertThrows(ResponseStatusException.<span style=color:#a6e22e>class</span>, () <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>      appController.<span style=color:#a6e22e>getAllTasks</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>新規のタスク作成処理を呼ぶ際に引数を正しくセットしている</span>() {
</span></span><span style=display:flex><span>    NewTask task <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NewTask(<span style=color:#e6db74>&#34;Task Title&#34;</span>, <span style=color:#e6db74>&#34;Task Description&#34;</span>);
</span></span><span style=display:flex><span>    appController.<span style=color:#a6e22e>createTask</span>(task);
</span></span><span style=display:flex><span>    verify(appService).<span style=color:#a6e22e>createNewTask</span>(argCaptor.<span style=color:#a6e22e>capture</span>());
</span></span><span style=display:flex><span>    assertThat(argCaptor.<span style=color:#a6e22e>getValue</span>().<span style=color:#a6e22e>title</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;Task Title&#34;</span>);
</span></span><span style=display:flex><span>    assertThat(argCaptor.<span style=color:#a6e22e>getValue</span>().<span style=color:#a6e22e>description</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;Task Description&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>最後に1件テストを追加しました。これも解説していきます。
最初の2行はシンプルにTodoAppControllerのcreateTasks()を呼んでいるだけです。</p><p>さてその次に、<code>verify(appService).createNewTask(argCaptor.capture());</code>
という記述が出てきました。</p><pre tabindex=0><code>@Captor
private ArgumentCaptor&lt;NewTask&gt; argCaptor;
</code></pre><p>キャプチャをここで仕込んでいます。
あとはキャプチャから値を取り出して、それがControllerのcreateTask()に与えた引数と一致しているかどうかを検証しているだけです。</p><p>どうでしょう、ここまででMockitoによるモッキングがいかに強力で、様々なテストが柔軟におこなえるようになるということが伝わりましょうか？
このControllerには他にも様々なメソッドが実装されてます。
上記のテストを参考にして、他のメソッドのテストを皆さんで実装されてみてください。
テストダブルを使用したテストはDIの仕組みも絡むため慣れるまでがけっこう大変です。
より多くのテストを書いて慣れることがとにかく大事です。</p><h3 id=完成したテスト>完成したテスト
<a class=anchor href=#%e5%ae%8c%e6%88%90%e3%81%97%e3%81%9f%e3%83%86%e3%82%b9%e3%83%88>#</a></h3><p>完成したリポジトリは <a href=https://github.com/Onebase-Fujitsu/simple-todo-app/tree/unittest>ここで公開あります</a> ので、もしわからなくなったら見てみてください。</p><p><a href=https://github.com/Onebase-Fujitsu/simple-todo-app/blob/unittest/server/src/test/java/com/example/todoApp/controller/TodoAppControllerUnitTest.java>ユニットテストのソースコードはこちら</a> になります。</p><h2 id=mockitoを使ったインテグレーションテスト>Mockitoを使ったインテグレーションテスト
<a class=anchor href=#mockito%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%9f%e3%82%a4%e3%83%b3%e3%83%86%e3%82%b0%e3%83%ac%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%83%86%e3%82%b9%e3%83%88>#</a></h2><p>さて、次は複数のモジュールを組み合わせたインテグレーションテストに挑戦してみましょう。
Spring Bootでは擬似的にHTTP通信をおこなう、TestRestTemplateという機能が用意されています。
これを使ってControllerの各メソッドに対してHTTPリクエストを発生させて、戻ってきたHttpResponseを評価してみましょう。</p><p>インテグレーションテストも本物の実装を使ったり、特定のクラスをモッキングしたり自由自在なテストを実装することができます。
実際にテストを書いてみてテストダブルと依存性注入の強力さを体感してみてください。
コードを眺めるだけではなく実際に手を動かして書いてみることがとても大事です。一緒にやってみましょう。</p><h3 id=最初のテスト-1>最初のテスト
<a class=anchor href=#%e6%9c%80%e5%88%9d%e3%81%ae%e3%83%86%e3%82%b9%e3%83%88-1>#</a></h3><p>では早速テストを書いていきましょう。
<code>server\src\test\java\com.example.todoApp.controller</code>配下に<code>TodoAppControllerIntegrationTest.java</code>を作りましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// TodoAppControllerIntegrationTest.java</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.context.SpringBootTest;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.test.context.jdbc.Sql;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(webEnvironment <span style=color:#f92672>=</span> SpringBootTest.<span style=color:#a6e22e>WebEnvironment</span>.<span style=color:#a6e22e>RANDOM_PORT</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Sql</span>(scripts <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/clear_db.sql&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TodoAppControllerIntegrationTest</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TestRestTemplate restTemplate;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>まずは、これが雛形になってきます。
また見慣れない記述が出てきたと思いますので、解説します。</p><p><code>@SpringBootTest</code>はテストでSpringBootの機能を使えるようにしてくれてるものです。
今回はサーバをランダムなポートで起動しています。</p><p><code>@Sql</code>を使うと指定したSQLをテストの度に実行してくれるようになります。
JUnitでは所定の順序でテストが実行されるわけですが、DBに値を格納するようなテストを書いたとき、
それ以降に実行されるテストはDBに値が格納されていることを前提にして書かないといけなくなります。
つまり、テストの順番を意識したテストを書かないといけなくなるということです。</p><p>順序を意識するのはとても大変ですし、安易にテストの順番を入れ替えたり、
削除したり追加したりといったリファクタリングが難しくなってしまいますので、
今回はDBの内容を毎回クリアするSQLをテストの度に実行することで、テストの順序を気にしなくてもいいようにしています。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>/* clear_db.sql */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>truncate</span> <span style=color:#66d9ef>table</span> task;
</span></span><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> task <span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>COLUMN</span> id <span style=color:#66d9ef>RESTART</span> <span style=color:#66d9ef>WITH</span> <span style=color:#ae81ff>1</span>;
</span></span></code></pre></div><p><code>@Autowired</code>はSpring FrameworkのDIコンテナからインスタンスを取得するための宣言です。
ここでは、そこまでこれを意識した実装は行わないので、いったんおまじないぐらいに考えてください。</p><p>それでは、まずタスクが登録されていない状態でタスクを全件取得するAPIを呼び出すと空の配列が返ってくることを確認してみましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// TodoAppControllerIntegrationTest.java</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> com.example.todoApp.controller;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.example.todoApp.model.Task;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.Test;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.context.SpringBootTest;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.test.context.jdbc.Sql;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.web.client.TestRestTemplate;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.http.*;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.assertj.core.api.AssertionsForClassTypes.assertThat;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Objects;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(webEnvironment <span style=color:#f92672>=</span> SpringBootTest.<span style=color:#a6e22e>WebEnvironment</span>.<span style=color:#a6e22e>RANDOM_PORT</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Sql</span>(scripts <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/clear_db.sql&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TodoAppControllerIntegrationTest</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TestRestTemplate restTemplate;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>なにもタスクを作成していない場合は0件が返す</span>() {
</span></span><span style=display:flex><span>    ResponseEntity<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>[]&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>GET</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, Task<span style=color:#f92672>[]</span>.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span>    assertThat(Objects.<span style=color:#a6e22e>requireNonNull</span>(response.<span style=color:#a6e22e>getBody</span>()).<span style=color:#a6e22e>length</span>).<span style=color:#a6e22e>isEqualTo</span>(0);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>テストを実行してみましょう。IDEを使っている方はIDEからテストを呼び出してもいいですし、
IDEを使っていない方はTerminalで</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./gradlew test
</span></span></code></pre></div><p>もしくは</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gradlew.bat test
</span></span></code></pre></div><p>を実行してみましょう。通りましたでしょうか？</p><p>このテストではrestTemplateを使って擬似的にHTTPリクエストを行い、そのレスポンスを評価してます。
個々では<code>/tasks</code>に対してGETメソッドでリクエストを実行してますね。
そしてレスポンスが200番(つまりHttpStatus.OK)であり、Bodyが空配列のJSON<code>[]</code>であることを評価しています。</p><p>ここまでは大丈夫でしょうか？</p><h3 id=2番目のテスト-1>2番目のテスト
<a class=anchor href=#2%e7%95%aa%e7%9b%ae%e3%81%ae%e3%83%86%e3%82%b9%e3%83%88-1>#</a></h3><p>さて次にタスクを作ってみましょう。同じようにrestTemplateを使ってPOSTのリクエストをしたらいいですよね。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// TodoAppControllerIntegrationTest.java</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> com.example.todoApp.controller;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.example.todoApp.model.Task;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> net.minidev.json.JSONObject;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.Test;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.context.SpringBootTest;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.test.context.jdbc.Sql;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.web.client.TestRestTemplate;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.http.*;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.assertj.core.api.AssertionsForClassTypes.assertThat;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Objects;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(webEnvironment <span style=color:#f92672>=</span> SpringBootTest.<span style=color:#a6e22e>WebEnvironment</span>.<span style=color:#a6e22e>RANDOM_PORT</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Sql</span>(scripts <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/clear_db.sql&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TodoAppControllerIntegrationTest</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TestRestTemplate restTemplate;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>なにもタスクを作成していない場合は0件が返す</span>() {
</span></span><span style=display:flex><span>    ResponseEntity<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>[]&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>GET</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, Task<span style=color:#f92672>[]</span>.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span>    assertThat(Objects.<span style=color:#a6e22e>requireNonNull</span>(response.<span style=color:#a6e22e>getBody</span>()).<span style=color:#a6e22e>length</span>).<span style=color:#a6e22e>isEqualTo</span>(0);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>タスクを新規に作成するとCREATEDを返す</span>() {
</span></span><span style=display:flex><span>    HttpHeaders headers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpHeaders();
</span></span><span style=display:flex><span>    headers.<span style=color:#a6e22e>setContentType</span>(MediaType.<span style=color:#a6e22e>APPLICATION_JSON</span>);
</span></span><span style=display:flex><span>    JSONObject taskJson <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JSONObject();
</span></span><span style=display:flex><span>    taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;title&#34;</span>, <span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>    taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;description&#34;</span>, <span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>POST</span>, <span style=color:#66d9ef>new</span> HttpEntity<span style=color:#f92672>&lt;&gt;</span>(taskJson.<span style=color:#a6e22e>toString</span>(), headers), String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>CREATED</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>これもテストを実行すると問題なくテストは通るはずです。
最初にJSONオブジェクトを作って、それをPOSTリクエストのBodyにつけています。
そして、戻ってきたレスポンスが201番(HttpStatus.CREATED)であることを評価してます。</p><h3 id=時間を予測可能にする>時間を予測可能にする
<a class=anchor href=#%e6%99%82%e9%96%93%e3%82%92%e4%ba%88%e6%b8%ac%e5%8f%af%e8%83%bd%e3%81%ab%e3%81%99%e3%82%8b>#</a></h3><p>では作ったタスクを取得してそれを評価してみましょう。ここから少し難しくなりますが、頑張ってついてきてください。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// TodoAppControllerIntegrationTest.java</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> com.example.todoApp.controller;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.example.todoApp.model.Task;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> net.minidev.json.JSONObject;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.Test;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.context.SpringBootTest;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.test.context.jdbc.Sql;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.web.client.TestRestTemplate;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.http.*;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.assertj.core.api.AssertionsForClassTypes.assertThat;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Objects;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(webEnvironment <span style=color:#f92672>=</span> SpringBootTest.<span style=color:#a6e22e>WebEnvironment</span>.<span style=color:#a6e22e>RANDOM_PORT</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Sql</span>(scripts <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/clear_db.sql&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TodoAppControllerIntegrationTest</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TestRestTemplate restTemplate;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>なにもタスクを作成していない場合は0件が返す</span>() {
</span></span><span style=display:flex><span>    ResponseEntity<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>[]&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>GET</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, Task<span style=color:#f92672>[]</span>.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span>    assertThat(Objects.<span style=color:#a6e22e>requireNonNull</span>(response.<span style=color:#a6e22e>getBody</span>()).<span style=color:#a6e22e>length</span>).<span style=color:#a6e22e>isEqualTo</span>(0);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>タスクを新規に作成するとCREATEDを返す</span>() {
</span></span><span style=display:flex><span>    HttpHeaders headers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpHeaders();
</span></span><span style=display:flex><span>    headers.<span style=color:#a6e22e>setContentType</span>(MediaType.<span style=color:#a6e22e>APPLICATION_JSON</span>);
</span></span><span style=display:flex><span>    JSONObject taskJson <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JSONObject();
</span></span><span style=display:flex><span>    taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;title&#34;</span>, <span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>    taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;description&#34;</span>, <span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>POST</span>, <span style=color:#66d9ef>new</span> HttpEntity<span style=color:#f92672>&lt;&gt;</span>(taskJson.<span style=color:#a6e22e>toString</span>(), headers), String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>CREATED</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>タスクがあるとその情報を取得できる</span>() {
</span></span><span style=display:flex><span>    HttpHeaders headers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpHeaders();
</span></span><span style=display:flex><span>    headers.<span style=color:#a6e22e>setContentType</span>(MediaType.<span style=color:#a6e22e>APPLICATION_JSON</span>);
</span></span><span style=display:flex><span>    JSONObject taskJson <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JSONObject();
</span></span><span style=display:flex><span>    taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;title&#34;</span>, <span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>    taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;description&#34;</span>, <span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>    restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>POST</span>, <span style=color:#66d9ef>new</span> HttpEntity<span style=color:#f92672>&lt;&gt;</span>(taskJson.<span style=color:#a6e22e>toString</span>(), headers), String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    ResponseEntity<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>[]&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>GET</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, Task<span style=color:#f92672>[]</span>.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span>    assertThat(Objects.<span style=color:#a6e22e>requireNonNull</span>(response.<span style=color:#a6e22e>getBody</span>()).<span style=color:#a6e22e>length</span>).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span>    assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>title</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>    assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>description</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>    assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>isDone</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>タスクを作ってそのタスクを評価するテストを書きました。
この後はタスクを作って、そのタスクに対する処理を続けて書くことになりますし、少しリファクタリングしましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// TodoAppControllerIntegrationTest.java</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> com.example.todoApp.controller;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.example.todoApp.model.Task;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> net.minidev.json.JSONObject;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.BeforeEach;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.Nested;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.Test;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.context.SpringBootTest;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.test.context.jdbc.Sql;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.web.client.TestRestTemplate;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.http.*;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.assertj.core.api.AssertionsForClassTypes.assertThat;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Objects;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(webEnvironment <span style=color:#f92672>=</span> SpringBootTest.<span style=color:#a6e22e>WebEnvironment</span>.<span style=color:#a6e22e>RANDOM_PORT</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Sql</span>(scripts <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/clear_db.sql&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TodoAppControllerIntegrationTest</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TestRestTemplate restTemplate;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>なにもタスクを作成していない場合は0件が返す</span>() {
</span></span><span style=display:flex><span>    ResponseEntity<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>[]&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>GET</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, Task<span style=color:#f92672>[]</span>.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span>    assertThat(Objects.<span style=color:#a6e22e>requireNonNull</span>(response.<span style=color:#a6e22e>getBody</span>()).<span style=color:#a6e22e>length</span>).<span style=color:#a6e22e>isEqualTo</span>(0);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>タスクを新規に作成するとCREATEDを返す</span>() {
</span></span><span style=display:flex><span>    HttpHeaders headers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpHeaders();
</span></span><span style=display:flex><span>    headers.<span style=color:#a6e22e>setContentType</span>(MediaType.<span style=color:#a6e22e>APPLICATION_JSON</span>);
</span></span><span style=display:flex><span>    JSONObject taskJson <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JSONObject();
</span></span><span style=display:flex><span>    taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;title&#34;</span>, <span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>    taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;description&#34;</span>, <span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>POST</span>, <span style=color:#66d9ef>new</span> HttpEntity<span style=color:#f92672>&lt;&gt;</span>(taskJson.<span style=color:#a6e22e>toString</span>(), headers), String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>CREATED</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Nested</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>既存のタスクに対する操作</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@BeforeEach</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setup</span>() {
</span></span><span style=display:flex><span>      HttpHeaders headers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpHeaders();
</span></span><span style=display:flex><span>      headers.<span style=color:#a6e22e>setContentType</span>(MediaType.<span style=color:#a6e22e>APPLICATION_JSON</span>);
</span></span><span style=display:flex><span>      JSONObject taskJson <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JSONObject();
</span></span><span style=display:flex><span>      taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;title&#34;</span>, <span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>      taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;description&#34;</span>, <span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>      restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>POST</span>, <span style=color:#66d9ef>new</span> HttpEntity<span style=color:#f92672>&lt;&gt;</span>(taskJson.<span style=color:#a6e22e>toString</span>(), headers), Object.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>タスクがあるとその情報を取得できる</span>() {
</span></span><span style=display:flex><span>      ResponseEntity<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>[]&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>GET</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, Task<span style=color:#f92672>[]</span>.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span>      assertThat(Objects.<span style=color:#a6e22e>requireNonNull</span>(response.<span style=color:#a6e22e>getBody</span>()).<span style=color:#a6e22e>length</span>).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>title</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>description</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>isDone</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>@Nested</code>を使って複数のテストをグルーピングできるようにしました。<code>@BeforeEach</code>を使ってテストの前にタスクを1件作る操作を入れています。</p><p>さて、このテストは通るのですが、このテストは <strong>タスクが作られた時間とタスクが更新された時間を評価していません。</strong>
試しに、最後のテストを以下のように変更してみてテストを実行してみてください。</p><pre tabindex=0><code>@Test
public void タスクがあるとその情報を取得できる() {
  ResponseEntity&lt;Task[]&gt; response = restTemplate.exchange(&#34;/tasks&#34;, HttpMethod.GET, HttpEntity.EMPTY, Task[].class);
  assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
  assertThat(Objects.requireNonNull(response.getBody()).length).isEqualTo(1);

  assertThat(response.getBody()[0].id).isEqualTo(1);
  assertThat(response.getBody()[0].title).isEqualTo(&#34;foo&#34;);
  assertThat(response.getBody()[0].description).isEqualTo(&#34;bar&#34;);
  assertThat(response.getBody()[0].isDone).isEqualTo(false);
  System.out.println(response.getBody()[0].createdAt);
}
</code></pre><p>コンソールには以下のような出力がされるはずです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>2021-08-19 19:19:40.381  INFO <span style=color:#ae81ff>11622</span> --- <span style=color:#f92672>[</span>o-auto-1-exec-1<span style=color:#f92672>]</span> o.a.c.c.C.<span style=color:#f92672>[</span>Tomcat<span style=color:#f92672>]</span>.<span style=color:#f92672>[</span>localhost<span style=color:#f92672>]</span>.<span style=color:#f92672>[</span>/<span style=color:#f92672>]</span>       : Initializing Spring DispatcherServlet <span style=color:#e6db74>&#39;dispatcherServlet&#39;</span>
</span></span><span style=display:flex><span>2021-08-19 19:19:40.382  INFO <span style=color:#ae81ff>11622</span> --- <span style=color:#f92672>[</span>o-auto-1-exec-1<span style=color:#f92672>]</span> o.s.web.servlet.DispatcherServlet        : Initializing Servlet <span style=color:#e6db74>&#39;dispatcherServlet&#39;</span>
</span></span><span style=display:flex><span>2021-08-19 19:19:40.383  INFO <span style=color:#ae81ff>11622</span> --- <span style=color:#f92672>[</span>o-auto-1-exec-1<span style=color:#f92672>]</span> o.s.web.servlet.DispatcherServlet        : Completed initialization in <span style=color:#ae81ff>1</span> ms
</span></span><span style=display:flex><span>2021-08-19T10:19:40.427207Z
</span></span></code></pre></div><p>最後の一行がprintln()の出力です。テストを実行した時間になっていると思います。
つまり、<strong>テストを実行する度にこの値は変わってしまいます。</strong> このままでは再現性の高いテストを書くことができません。</p><p>そこで使うのがMockです。Mockitoを使ってClockServiceをモッキングした後、
それを依存性注入して、now()を呼び出したときに特定の時間を返すようにしてみましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// TodoAppControllerIntegrationTest.java</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> com.example.todoApp.controller;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.example.todoApp.model.Task;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.example.todoApp.service.ClockServiceInterface;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> net.minidev.json.JSONObject;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.BeforeEach;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.Nested;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.Test;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.context.SpringBootTest;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.mock.mockito.MockBean;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.test.context.jdbc.Sql;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.web.client.TestRestTemplate;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.http.*;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.assertj.core.api.AssertionsForClassTypes.assertThat;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.mockito.Mockito.when;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.time.OffsetDateTime;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Objects;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(webEnvironment <span style=color:#f92672>=</span> SpringBootTest.<span style=color:#a6e22e>WebEnvironment</span>.<span style=color:#a6e22e>RANDOM_PORT</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Sql</span>(scripts <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/clear_db.sql&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TodoAppControllerIntegrationTest</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TestRestTemplate restTemplate;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@MockBean</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> ClockServiceInterface clockService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@BeforeEach</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setup</span>() {
</span></span><span style=display:flex><span>    doReturn(OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-19T15:00:00+09:00&#34;</span>).<span style=color:#a6e22e>toInstant</span>()).<span style=color:#a6e22e>when</span>(clockService).<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>なにもタスクを作成していない場合は0件が返す</span>() {
</span></span><span style=display:flex><span>    ResponseEntity<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>[]&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>GET</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, Task<span style=color:#f92672>[]</span>.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span>    assertThat(Objects.<span style=color:#a6e22e>requireNonNull</span>(response.<span style=color:#a6e22e>getBody</span>()).<span style=color:#a6e22e>length</span>).<span style=color:#a6e22e>isEqualTo</span>(0);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>タスクを新規に作成するとCREATEDを返す</span>() {
</span></span><span style=display:flex><span>    HttpHeaders headers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpHeaders();
</span></span><span style=display:flex><span>    headers.<span style=color:#a6e22e>setContentType</span>(MediaType.<span style=color:#a6e22e>APPLICATION_JSON</span>);
</span></span><span style=display:flex><span>    JSONObject taskJson <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JSONObject();
</span></span><span style=display:flex><span>    taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;title&#34;</span>, <span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>    taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;description&#34;</span>, <span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>POST</span>, <span style=color:#66d9ef>new</span> HttpEntity<span style=color:#f92672>&lt;&gt;</span>(taskJson.<span style=color:#a6e22e>toString</span>(), headers), String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>CREATED</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Nested</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>既存のタスクに対する操作</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@BeforeEach</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setup</span>() {
</span></span><span style=display:flex><span>      HttpHeaders headers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpHeaders();
</span></span><span style=display:flex><span>      headers.<span style=color:#a6e22e>setContentType</span>(MediaType.<span style=color:#a6e22e>APPLICATION_JSON</span>);
</span></span><span style=display:flex><span>      JSONObject taskJson <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JSONObject();
</span></span><span style=display:flex><span>      taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;title&#34;</span>, <span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>      taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;description&#34;</span>, <span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>      restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>POST</span>, <span style=color:#66d9ef>new</span> HttpEntity<span style=color:#f92672>&lt;&gt;</span>(taskJson.<span style=color:#a6e22e>toString</span>(), headers), Object.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>タスクがあるとその情報を取得できる</span>() {
</span></span><span style=display:flex><span>      ResponseEntity<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>[]&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>GET</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, Task<span style=color:#f92672>[]</span>.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span>      assertThat(Objects.<span style=color:#a6e22e>requireNonNull</span>(response.<span style=color:#a6e22e>getBody</span>()).<span style=color:#a6e22e>length</span>).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>title</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>description</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>isDone</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>createdAt</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;2021-08-19T15:00:00+09:00&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>updatedAt</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;2021-08-19T15:00:00+09:00&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>書けましたか？ここでまた見慣れない<code>@MockBean</code>という見慣れないアノテーションがでてきました。
これはSpring Frameworkが提供しているアノテーションです。</p><p>Mockitoを使ったControllerのユニットテストの <a href=#%e6%9c%80%e5%88%9d%e3%81%ae%e3%83%86%e3%82%b9%e3%83%88>最初のテスト</a> では<code>@Mock</code>と<code>@InjectMocks</code>というMockitoの機能がでてきました。
これは@Mockで作ったMockオブジェクトを@InjectMocksに注入する機能でした。</p><p><code>@MockBean</code>はそれをまとめてやってくれるSpring Frameworkの便利機能です。
Mockを作ってDIコンテナに登録して、テストを実行するときに自動で@Autowiredしてくれます。
めちゃくちゃ便利なんですがSpring Framework独自の機能だということに注意してください。</p><p>さてここで以下のような記述が登場しました。</p><pre tabindex=0><code>@BeforeEach
public void setup() {
    doReturn(OffsetDateTime.parse(&#34;2021-08-19T15:00:00+09:00&#34;).toInstant()).when(clockService).now();
}
</code></pre><p>whenやdoReturnはすでに説明不要で大丈夫ですよね？
つまり、一連のテストではclockServiceInterfaceのnow()メソッドを呼び出すと、日本時間の2021年08月19日15:00:00を返すと宣言したわけです。
こうすると、いつテストを実行してもnow()は決まった時間になります。
つまり再現性の高いテストが書けるようにようになったということです。</p><pre tabindex=0><code>@Test
public void タスクがあるとその情報を取得できる() {
  ResponseEntity&lt;Task[]&gt; response = restTemplate.exchange(&#34;/tasks&#34;, HttpMethod.GET, HttpEntity.EMPTY, Task[].class);
  assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
  assertThat(Objects.requireNonNull(response.getBody()).length).isEqualTo(1);

  assertThat(response.getBody()[0].id).isEqualTo(1);
  assertThat(response.getBody()[0].title).isEqualTo(&#34;foo&#34;);
  assertThat(response.getBody()[0].description).isEqualTo(&#34;bar&#34;);
  assertThat(response.getBody()[0].isDone).isEqualTo(false);
  assertThat(response.getBody()[0].createdAt).isEqualTo(&#34;2021-08-19T15:00:00+09:00&#34;);
  assertThat(response.getBody()[0].updatedAt).isEqualTo(&#34;2021-08-19T15:00:00+09:00&#34;);
}
</code></pre><p>最後のテストで時間を評価していることがわかると思います。</p><p>ここまでできましたでしょうか？おめでとうございます！あなたは時間を自由自在にコントロールできました！</p><blockquote class="book-hint info">**MockBeanのユースケース**
ここでは時間でしたが、世の中には様々な予測不可能なものがあります。
例えばバックエンドのServiceが外部のAPIを呼ぶようなケースはどうでしょう？
気象庁は天気予報のAPIを公開していて [https://www.jma.go.jp/bosai/forecast/data/overview_forecast/130000.json](https://www.jma.go.jp/bosai/forecast/data/overview_forecast/130000.json) にアクセスすると東京の天気予報をJSONで取得できます。
ではここで、気象庁の天気予報APIを使って商品の売上を予測するような業務ロジックを書いたとしましょう。
しかし、本物のAPIをテストが呼び出してしまうと、日時はテストを実行する度に変わってしまいますし、
天気もどんな内容が返ってくるかわからないですよね？
そこで今回覚えたMockです！APIのレスポンスをモッキングしてDIしてしまえば、どんなAPIのレスポンスでもテストで作れてしまうわけです！
いかに便利で強力な仕組みか理解できましたか？</blockquote><h3 id=時間をコントロールする>時間をコントロールする
<a class=anchor href=#%e6%99%82%e9%96%93%e3%82%92%e3%82%b3%e3%83%b3%e3%83%88%e3%83%ad%e3%83%bc%e3%83%ab%e3%81%99%e3%82%8b>#</a></h3><p>では次に、タスクを作った30分後にタスクを完了したときのタスクの状態を評価するというテストを書いてみましょう。
先のテストができていれば、もうこれはできたも同然だったりします。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// TodoAppControllerIntegrationTest.java</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> com.example.todoApp.controller;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.example.todoApp.model.Task;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.example.todoApp.service.ClockServiceInterface;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> net.minidev.json.JSONObject;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.BeforeEach;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.Nested;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.Test;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.context.SpringBootTest;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.mock.mockito.MockBean;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.test.context.jdbc.Sql;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.web.client.TestRestTemplate;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.http.*;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.assertj.core.api.AssertionsForClassTypes.assertThat;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.mockito.Mockito.doReturn;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.time.OffsetDateTime;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.time.temporal.ChronoUnit;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Objects;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(webEnvironment <span style=color:#f92672>=</span> SpringBootTest.<span style=color:#a6e22e>WebEnvironment</span>.<span style=color:#a6e22e>RANDOM_PORT</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Sql</span>(scripts <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/clear_db.sql&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TodoAppControllerIntegrationTest</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TestRestTemplate restTemplate;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@MockBean</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> ClockServiceInterface clockService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@BeforeEach</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setup</span>() {
</span></span><span style=display:flex><span>    doReturn(OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-19T15:00:00+09:00&#34;</span>).<span style=color:#a6e22e>toInstant</span>()).<span style=color:#a6e22e>when</span>(clockService).<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>なにもタスクを作成していない場合は0件が返す</span>() {
</span></span><span style=display:flex><span>    ResponseEntity<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>[]&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>GET</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, Task<span style=color:#f92672>[]</span>.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span>    assertThat(Objects.<span style=color:#a6e22e>requireNonNull</span>(response.<span style=color:#a6e22e>getBody</span>()).<span style=color:#a6e22e>length</span>).<span style=color:#a6e22e>isEqualTo</span>(0);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>タスクを新規に作成するとCREATEDを返す</span>() {
</span></span><span style=display:flex><span>    HttpHeaders headers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpHeaders();
</span></span><span style=display:flex><span>    headers.<span style=color:#a6e22e>setContentType</span>(MediaType.<span style=color:#a6e22e>APPLICATION_JSON</span>);
</span></span><span style=display:flex><span>    JSONObject taskJson <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JSONObject();
</span></span><span style=display:flex><span>    taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;title&#34;</span>, <span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>    taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;description&#34;</span>, <span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>POST</span>, <span style=color:#66d9ef>new</span> HttpEntity<span style=color:#f92672>&lt;&gt;</span>(taskJson.<span style=color:#a6e22e>toString</span>(), headers), String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>CREATED</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Nested</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>既存のタスクに対する操作</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@BeforeEach</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setup</span>() {
</span></span><span style=display:flex><span>      HttpHeaders headers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpHeaders();
</span></span><span style=display:flex><span>      headers.<span style=color:#a6e22e>setContentType</span>(MediaType.<span style=color:#a6e22e>APPLICATION_JSON</span>);
</span></span><span style=display:flex><span>      JSONObject taskJson <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JSONObject();
</span></span><span style=display:flex><span>      taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;title&#34;</span>, <span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>      taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;description&#34;</span>, <span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>      restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>POST</span>, <span style=color:#66d9ef>new</span> HttpEntity<span style=color:#f92672>&lt;&gt;</span>(taskJson.<span style=color:#a6e22e>toString</span>(), headers), Object.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>タスクがあるとその情報を取得できる</span>() {
</span></span><span style=display:flex><span>      ResponseEntity<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>[]&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>GET</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, Task<span style=color:#f92672>[]</span>.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span>      assertThat(Objects.<span style=color:#a6e22e>requireNonNull</span>(response.<span style=color:#a6e22e>getBody</span>()).<span style=color:#a6e22e>length</span>).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>title</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>description</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>isDone</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>createdAt</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;2021-08-19T15:00:00+09:00&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>updatedAt</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;2021-08-19T15:00:00+09:00&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>タスクを完了できる</span>() {
</span></span><span style=display:flex><span>      doReturn(clockService.<span style=color:#a6e22e>now</span>().<span style=color:#a6e22e>plus</span>(30, ChronoUnit.<span style=color:#a6e22e>MINUTES</span>)).<span style=color:#a6e22e>when</span>(clockService).<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>      ResponseEntity<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> operationResponse <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks/1/finish&#34;</span>, HttpMethod.<span style=color:#a6e22e>PUT</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, Object.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>      assertThat(operationResponse.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      ResponseEntity<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>[]&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>GET</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, Task<span style=color:#f92672>[]</span>.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span>      assertThat(Objects.<span style=color:#a6e22e>requireNonNull</span>(response.<span style=color:#a6e22e>getBody</span>()).<span style=color:#a6e22e>length</span>).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>title</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>description</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>isDone</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>createdAt</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;2021-08-19T15:00:00+09:00&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>updatedAt</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;2021-08-19T15:30:00+09:00&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>30分後にタスクを完了するテストを書いてみました。</p><pre tabindex=0><code>doReturn(clockService.now().plus(30, ChronoUnit.MINUTES)).when(clockService).now();
</code></pre><p>これがポイントです。すでにStubされているclockService.now()を上書きしてるんですね。
その状態でfinishAPIを呼んでいるわけです。</p><p>テストと実行すると、ちゃんとupdatedAtが30分後の2021年8月19日の15時30分になっているのがわかると思います。
いかがでしょうか、時間を自由自在に操れるようになりましたか？</p><h3 id=例外のテスト-1>例外のテスト
<a class=anchor href=#%e4%be%8b%e5%a4%96%e3%81%ae%e3%83%86%e3%82%b9%e3%83%88-1>#</a></h3><p>さて、ここまで本物のDBにアクセスをしてテストを実行してきました。
では、DBアクセス例外のテストはどうでしょうか？</p><p>他のテストでは本物のDBを使っているので、それに影響が無いようにしたいです。
それを実現する機能もちゃんと用意されています。ではテストを書いてみましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// TodoAppControllerIntegrationTest.java</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> com.example.todoApp.controller;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.example.todoApp.model.Task;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.example.todoApp.service.ClockServiceInterface;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.example.todoApp.service.TodoAppServiceInterface;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> net.minidev.json.JSONObject;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.BeforeEach;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.Nested;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.Test;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.context.SpringBootTest;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.mock.mockito.MockBean;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.mock.mockito.SpyBean;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.test.context.jdbc.Sql;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.web.client.TestRestTemplate;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.dao.DataAccessException;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.http.*;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.assertj.core.api.AssertionsForClassTypes.assertThat;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.mockito.Mockito.doReturn;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.mockito.Mockito.doThrow;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.time.OffsetDateTime;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.time.temporal.ChronoUnit;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Objects;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(webEnvironment <span style=color:#f92672>=</span> SpringBootTest.<span style=color:#a6e22e>WebEnvironment</span>.<span style=color:#a6e22e>RANDOM_PORT</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Sql</span>(scripts <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/clear_db.sql&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TodoAppControllerIntegrationTest</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TestRestTemplate restTemplate;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@MockBean</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> ClockServiceInterface clockService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@SpyBean</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TodoAppServiceInterface todoAppRepository;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@BeforeEach</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setup</span>() {
</span></span><span style=display:flex><span>    doReturn(OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-19T15:00:00+09:00&#34;</span>).<span style=color:#a6e22e>toInstant</span>()).<span style=color:#a6e22e>when</span>(clockService).<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>なにもタスクを作成していない場合は0件が返す</span>() {
</span></span><span style=display:flex><span>    ResponseEntity<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>[]&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>GET</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, Task<span style=color:#f92672>[]</span>.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span>    assertThat(Objects.<span style=color:#a6e22e>requireNonNull</span>(response.<span style=color:#a6e22e>getBody</span>()).<span style=color:#a6e22e>length</span>).<span style=color:#a6e22e>isEqualTo</span>(0);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>タスクを新規に作成するとCREATEDを返す</span>() {
</span></span><span style=display:flex><span>    HttpHeaders headers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpHeaders();
</span></span><span style=display:flex><span>    headers.<span style=color:#a6e22e>setContentType</span>(MediaType.<span style=color:#a6e22e>APPLICATION_JSON</span>);
</span></span><span style=display:flex><span>    JSONObject taskJson <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JSONObject();
</span></span><span style=display:flex><span>    taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;title&#34;</span>, <span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>    taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;description&#34;</span>, <span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>POST</span>, <span style=color:#66d9ef>new</span> HttpEntity<span style=color:#f92672>&lt;&gt;</span>(taskJson.<span style=color:#a6e22e>toString</span>(), headers), String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>CREATED</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Nested</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>既存のタスクに対する操作</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@BeforeEach</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setup</span>() {
</span></span><span style=display:flex><span>      HttpHeaders headers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpHeaders();
</span></span><span style=display:flex><span>      headers.<span style=color:#a6e22e>setContentType</span>(MediaType.<span style=color:#a6e22e>APPLICATION_JSON</span>);
</span></span><span style=display:flex><span>      JSONObject taskJson <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JSONObject();
</span></span><span style=display:flex><span>      taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;title&#34;</span>, <span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>      taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;description&#34;</span>, <span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>      restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>POST</span>, <span style=color:#66d9ef>new</span> HttpEntity<span style=color:#f92672>&lt;&gt;</span>(taskJson.<span style=color:#a6e22e>toString</span>(), headers), Object.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>タスクがあるとその情報を取得できる</span>() {
</span></span><span style=display:flex><span>      ResponseEntity<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>[]&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>GET</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, Task<span style=color:#f92672>[]</span>.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span>      assertThat(Objects.<span style=color:#a6e22e>requireNonNull</span>(response.<span style=color:#a6e22e>getBody</span>()).<span style=color:#a6e22e>length</span>).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>title</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>description</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>isDone</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>createdAt</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;2021-08-19T15:00:00+09:00&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>updatedAt</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;2021-08-19T15:00:00+09:00&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>タスクを完了できる</span>() {
</span></span><span style=display:flex><span>      doReturn(clockService.<span style=color:#a6e22e>now</span>().<span style=color:#a6e22e>plus</span>(30, ChronoUnit.<span style=color:#a6e22e>MINUTES</span>)).<span style=color:#a6e22e>when</span>(clockService).<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>      ResponseEntity<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> operationResponse <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks/1/finish&#34;</span>, HttpMethod.<span style=color:#a6e22e>PUT</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, Object.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>      assertThat(operationResponse.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      ResponseEntity<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>[]&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>GET</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, Task<span style=color:#f92672>[]</span>.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span>      assertThat(Objects.<span style=color:#a6e22e>requireNonNull</span>(response.<span style=color:#a6e22e>getBody</span>()).<span style=color:#a6e22e>length</span>).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>title</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>description</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>isDone</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>createdAt</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;2021-08-19T15:00:00+09:00&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>updatedAt</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;2021-08-19T15:30:00+09:00&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Nested</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DBアクセスエラー</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>取得メソッドでDBアクセスエラーが発生するとInternalServerErrorを返す</span>() {
</span></span><span style=display:flex><span>      doThrow(<span style=color:#66d9ef>new</span> DataAccessException(<span style=color:#e6db74>&#34;...&#34;</span>) {}).<span style=color:#a6e22e>when</span>(todoAppRepository).<span style=color:#a6e22e>getAllTasks</span>();
</span></span><span style=display:flex><span>      ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>GET</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>INTERNAL_SERVER_ERROR</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>こんな感じです。<code>@SpyBean</code>というアノテーションがでてきました。</p><pre tabindex=0><code>@SpyBean
private TodoAppServiceInterface todoAppRepository;
</code></pre><p>これも<code>@MockBean</code>と同じようにSpring Frameworkが提供している機能で、
MockitoでSpyオブジェクトを作ってDIコンテナに登録、テスト実行時に依存性注入してくれる非常に便利な機能です。</p><pre tabindex=0><code>@Nested
class DBアクセスエラー {
  @Test
  public void 取得メソッドでDBアクセスエラーが発生するとInternalServerErrorを返す() {
    doThrow(new DataAccessException(&#34;...&#34;) {}).when(todoAppRepository).getAllTasks();
    ResponseEntity&lt;String&gt; response = restTemplate.exchange(&#34;/tasks&#34;, HttpMethod.GET, HttpEntity.EMPTY, String.class);
    assertThat(response.getStatusCode()).isEqualTo(HttpStatus.INTERNAL_SERVER_ERROR);
  }
}
</code></pre><p>最後に追加しているのが、DBアクセスエラーのテストです。doThrowでtodoAppServiceInterfaceのgetAllTasks()メソッドが呼ばれたときに、DataAccessException例外をスローするよう宣言しています。
テストを実行するとちゃんとレスポンスとして500番(HttpStatus.INTERNAL_SERVER_ERROR)が返ってきているのが分かります。</p><p>getAllTasks()は引数が無いメソッドなのでいいですが、createNewTask()メソッドは引数の設定が必要です。
例外をテストするときに、どんな引数が与えられても例外を返したいという場面は多いです。</p><p>それもMockitoなら簡単に実装できます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// TodoAppControllerIntegrationTest.java</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> com.example.todoApp.controller;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.example.todoApp.model.Task;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.example.todoApp.service.ClockServiceInterface;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.example.todoApp.service.TodoAppServiceInterface;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> net.minidev.json.JSONObject;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.BeforeEach;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.Nested;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.jupiter.api.Test;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.context.SpringBootTest;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.mock.mockito.MockBean;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.mock.mockito.SpyBean;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.test.context.jdbc.Sql;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.test.web.client.TestRestTemplate;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.dao.DataAccessException;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.http.*;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.assertj.core.api.AssertionsForClassTypes.assertThat;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.mockito.ArgumentMatchers.any;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.mockito.Mockito.doReturn;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.mockito.Mockito.doThrow;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.time.OffsetDateTime;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.time.temporal.ChronoUnit;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Objects;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(webEnvironment <span style=color:#f92672>=</span> SpringBootTest.<span style=color:#a6e22e>WebEnvironment</span>.<span style=color:#a6e22e>RANDOM_PORT</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Sql</span>(scripts <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/clear_db.sql&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TodoAppControllerIntegrationTest</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TestRestTemplate restTemplate;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@MockBean</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> ClockServiceInterface clockService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@SpyBean</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TodoAppServiceInterface todoAppRepository;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@BeforeEach</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setup</span>() {
</span></span><span style=display:flex><span>    doReturn(OffsetDateTime.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;2021-08-19T15:00:00+09:00&#34;</span>).<span style=color:#a6e22e>toInstant</span>()).<span style=color:#a6e22e>when</span>(clockService).<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>なにもタスクを作成していない場合は0件が返す</span>() {
</span></span><span style=display:flex><span>    ResponseEntity<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>[]&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>GET</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, Task<span style=color:#f92672>[]</span>.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span>    assertThat(Objects.<span style=color:#a6e22e>requireNonNull</span>(response.<span style=color:#a6e22e>getBody</span>()).<span style=color:#a6e22e>length</span>).<span style=color:#a6e22e>isEqualTo</span>(0);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>タスクを新規に作成するとCREATEDを返す</span>() {
</span></span><span style=display:flex><span>    HttpHeaders headers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpHeaders();
</span></span><span style=display:flex><span>    headers.<span style=color:#a6e22e>setContentType</span>(MediaType.<span style=color:#a6e22e>APPLICATION_JSON</span>);
</span></span><span style=display:flex><span>    JSONObject taskJson <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JSONObject();
</span></span><span style=display:flex><span>    taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;title&#34;</span>, <span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>    taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;description&#34;</span>, <span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>POST</span>, <span style=color:#66d9ef>new</span> HttpEntity<span style=color:#f92672>&lt;&gt;</span>(taskJson.<span style=color:#a6e22e>toString</span>(), headers), String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>CREATED</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Nested</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>既存のタスクに対する操作</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@BeforeEach</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setup</span>() {
</span></span><span style=display:flex><span>      HttpHeaders headers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpHeaders();
</span></span><span style=display:flex><span>      headers.<span style=color:#a6e22e>setContentType</span>(MediaType.<span style=color:#a6e22e>APPLICATION_JSON</span>);
</span></span><span style=display:flex><span>      JSONObject taskJson <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JSONObject();
</span></span><span style=display:flex><span>      taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;title&#34;</span>, <span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>      taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;description&#34;</span>, <span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>      restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>POST</span>, <span style=color:#66d9ef>new</span> HttpEntity<span style=color:#f92672>&lt;&gt;</span>(taskJson.<span style=color:#a6e22e>toString</span>(), headers), Object.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>タスクがあるとその情報を取得できる</span>() {
</span></span><span style=display:flex><span>      ResponseEntity<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>[]&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>GET</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, Task<span style=color:#f92672>[]</span>.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span>      assertThat(Objects.<span style=color:#a6e22e>requireNonNull</span>(response.<span style=color:#a6e22e>getBody</span>()).<span style=color:#a6e22e>length</span>).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>title</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>description</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>isDone</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>createdAt</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;2021-08-19T15:00:00+09:00&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>updatedAt</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;2021-08-19T15:00:00+09:00&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>タスクを完了できる</span>() {
</span></span><span style=display:flex><span>      doReturn(clockService.<span style=color:#a6e22e>now</span>().<span style=color:#a6e22e>plus</span>(30, ChronoUnit.<span style=color:#a6e22e>MINUTES</span>)).<span style=color:#a6e22e>when</span>(clockService).<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>      ResponseEntity<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> operationResponse <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks/1/finish&#34;</span>, HttpMethod.<span style=color:#a6e22e>PUT</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, Object.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>      assertThat(operationResponse.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      ResponseEntity<span style=color:#f92672>&lt;</span>Task<span style=color:#f92672>[]&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>GET</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, Task<span style=color:#f92672>[]</span>.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span>      assertThat(Objects.<span style=color:#a6e22e>requireNonNull</span>(response.<span style=color:#a6e22e>getBody</span>()).<span style=color:#a6e22e>length</span>).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>title</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>description</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>isDone</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>createdAt</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;2021-08-19T15:00:00+09:00&#34;</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getBody</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.<span style=color:#a6e22e>updatedAt</span>).<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#e6db74>&#34;2021-08-19T15:30:00+09:00&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Nested</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DBアクセスエラー</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>取得メソッドでDBアクセスエラーが発生するとInternalServerErrorを返す</span>() {
</span></span><span style=display:flex><span>      doThrow(<span style=color:#66d9ef>new</span> DataAccessException(<span style=color:#e6db74>&#34;...&#34;</span>) {}).<span style=color:#a6e22e>when</span>(todoAppRepository).<span style=color:#a6e22e>getAllTasks</span>();
</span></span><span style=display:flex><span>      ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>GET</span>, HttpEntity.<span style=color:#a6e22e>EMPTY</span>, String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>INTERNAL_SERVER_ERROR</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>作成メソッドでDBアクセスエラーが発生するとInternalServerErrorを返す</span>() {
</span></span><span style=display:flex><span>      doThrow(<span style=color:#66d9ef>new</span> DataAccessException(<span style=color:#e6db74>&#34;...&#34;</span>){}).<span style=color:#a6e22e>when</span>(todoAppRepository).<span style=color:#a6e22e>createNewTask</span>(any(), any());
</span></span><span style=display:flex><span>      HttpHeaders headers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpHeaders();
</span></span><span style=display:flex><span>      headers.<span style=color:#a6e22e>setContentType</span>(MediaType.<span style=color:#a6e22e>APPLICATION_JSON</span>);
</span></span><span style=display:flex><span>      JSONObject taskJson <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JSONObject();
</span></span><span style=display:flex><span>      taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;title&#34;</span>, <span style=color:#e6db74>&#34;foo&#34;</span>);
</span></span><span style=display:flex><span>      taskJson.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;description&#34;</span>, <span style=color:#e6db74>&#34;bar&#34;</span>);
</span></span><span style=display:flex><span>      ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/tasks&#34;</span>, HttpMethod.<span style=color:#a6e22e>POST</span>, <span style=color:#66d9ef>new</span> HttpEntity<span style=color:#f92672>&lt;&gt;</span>(taskJson.<span style=color:#a6e22e>toString</span>(), headers), String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>      assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>INTERNAL_SERVER_ERROR</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>最後に追加したのは作成処理を呼んだときにDBアクセス例外が発生したときのテストです。</p><pre tabindex=0><code>doThrow(new DataAccessException(&#34;...&#34;){}).when(todoAppRepository).createNewTask(any(), any());
</code></pre><p>any()というのはMockitoが提供している引数のMatcherです。
なんでもいいよということですね。</p><p>例えば、any()ではなく、特定の値が引数で与えられたら例外をスローするといった挙動もStubすることができます！</p><p>ここまでで、できれば様々なテストが自分で実装できるはずです。
まだ未テストのAPIがあると思いますので、自分で考えてAPIを実装してみてください。
これもとにかく慣れるまで自分の手を動かして書いてみるのがとても大事です。</p><h3 id=完成したテスト-1>完成したテスト
<a class=anchor href=#%e5%ae%8c%e6%88%90%e3%81%97%e3%81%9f%e3%83%86%e3%82%b9%e3%83%88-1>#</a></h3><p>完成したリポジトリは <a href=https://github.com/Onebase-Fujitsu/simple-todo-app/tree/integrationtest>ここで公開あります</a> ので、もしわからなくなったら見てみてください。</p><p><a href=https://github.com/Onebase-Fujitsu/simple-todo-app/blob/integrationtest/server/src/test/java/com/example/todoApp/controller/TodoAppControllerIntegrationTest.java>インテグレーションテストのソースコードはこちら</a> になります。</p><h2 id=テスト駆動開発とユニットテストインテグレーションテスト>テスト駆動開発とユニットテスト・インテグレーションテスト
<a class=anchor href=#%e3%83%86%e3%82%b9%e3%83%88%e9%a7%86%e5%8b%95%e9%96%8b%e7%99%ba%e3%81%a8%e3%83%a6%e3%83%8b%e3%83%83%e3%83%88%e3%83%86%e3%82%b9%e3%83%88%e3%82%a4%e3%83%b3%e3%83%86%e3%82%b0%e3%83%ac%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%83%86%e3%82%b9%e3%83%88>#</a></h2><p>さて、ここまででMockitoを使ったMockオブジェクトで他のクラスに依存しない単体テストを書く方法や、
様々なクラスを組み合わせたインテグレーションテストの書き方を見てきました。</p><p>さて、実際にテスト駆動開発で新規の機能を追加するとなったとき、どういったテストをかけばよいでしょうか？</p><ol><li>まずユニットテストを記述して、それをパスする実装をして、それが通ったらインテグレーションテストを書いて検証する</li><li>まずインテグレーションテストを記述して、それをパスする実装をして、その上でインテグレーションテストで検証が難しい部分をユニットテストで検証する</li></ol><p>選択肢はこの2つでしょうか。 さて、1の「ユニットテストから書き始める」と思った方はいますでしょうか？</p><p>.</p><p>..</p><p>&mldr;</p><p>残念ながら不正解です！「あれ？ウォーターフォールだって最初にPTをやってその次にITをやるじゃないか！」と思われる方も多いかもしれません。
ですが、ちょっと考えてみてください。<strong>ユニットテストで実装できるテストはホワイトボックステスト</strong>です。
<strong>ホワイトボックステストは実装内容に非常に依存する</strong>のが特徴です。</p><p>つまり、
「実装コードがこうなっているから、この分岐を通るようなテストを実装しよう」だとか、
「実装コードがこうなっているから、この依存部品を正しく呼んでいるかを検証するようなテストを実装しよう」だとか、
そういう考えで実装するものなのですね。</p><p>さて、テスト駆動開発ではプロダクトの実装を行う前にテストを最初に書きます。
つまり、テストを書き始める段階で実装コードはまだないわけです。
その状態でどうやってユニットテストを書けと言われても難しいというのは想像に難くないのではないでしょうか？</p><p>「いやいや、TDDとはいえ実装に入る前に簡単な設計はするでしょ？」と思われる方もいるかもしれません。
はい、それも間違っていませんが、それでもインテグレーションテストから先に実装するのには理由があります。</p><p>先程前述したとおり、ホワイトボックステストは実装コードの内容に依存します。
しかし、我々はアジャイルで開発をしています。アジャイルで開発しているということは仕様がどんどん開発する過程で変化をするということです。
そうした中で自動テストがすべてホワイトボックステストで実装されていたらどうでしょうか？
答えは<strong>リファクタリングが難しくなります。</strong>
ちょっとした内部ロジックの修正でありとあらゆるところに影響範囲がでてしまうのは想像に難くないでしょう。
リファクタリングに多大な時間がかかるようになり、アジリティの高い開発とは程遠い結果を招いてしまいます。</p><p>ですので、<strong>最初にどういうリクエストをしたときに、どういう振る舞いをするのかを検証するインテグレーションテストを書いてから実装を始める</strong>ことがとても大事です。
実装を進める過程で、「ここ例外処理が必要だね」とか様々な会話が出てくると思います。
中にはインテグレーションテストでは検証が難しいケースも出てくるでしょう。
そうしたインテグレーションテストでは検証が難しい部分が出てきたときに、補完する目的でユニットテストを書くべきです。
しかし、やりすぎるとアジリティの低下を招きますので基本的にはすべてインテグレーションテストで検証すべきです。</p><p>「あれ？ホワイトボックステストを実装しないということはテストカバレッジ率は？」と思われる方もいるでしょう。</p><p>ここで大事なのは <strong>『カバレッジが低ければソースコードないしテストコードの品質は低い』と言えるが、
『カバレッジが高ければ、ソースコードの品質が高い』とは言えない</strong> ということです。
カバレッジを計測する目的は、テストが十分に網羅されていないコードを検出することで、
「テストケースが十分に網羅されていない」コードを限りなく少なくすることです。
すなわち、いくらカバレッジが高くても、テストケースの品質が悪ければ、バグが潜在している可能性を低くすることはできません。
<strong>カバレッジ率はテストの網羅率を測るのに有効ですが、それを目標にしてはいけません。</strong></p><p>「実践テスト駆動開発」という書籍があり、その中の一節を紹介します。</p><blockquote><p>システムの振る舞いは、オブジェクトの組み合わせから現れる性質なのだ。『オブジェクトの組み合わせ』とは、すなわち『どのオブジェクトを、どうつなげるか』ということだ。</p><p><strong>振る舞いのテストを行え、メソッドをテストするのではない</strong></p></blockquote><p><strong>テスト駆動開発(TDD)のいうところの"テスト"とはすなわち、振る舞い駆動開発(BDD)であるということを肝に銘じておくと良いでしょう。</strong></p><hr><p>では次にE2Eテストについて見ていきましょう。</p><a href=/agile-dev-guide/docs/softwaretest/e2e/ class=book-btn>E2Eテスト</a></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#テストダブルとは>テストダブルとは</a></li><li><a href=#テストダブルを実現するライブラリ>テストダブルを実現するライブラリ</a></li><li><a href=#サンプルアプリケーション>サンプルアプリケーション</a></li><li><a href=#mockitoを使ったcontrollerのユニットテスト>Mockitoを使ったControllerのユニットテスト</a><ul><li><a href=#バックエンドの構造>バックエンドの構造</a></li><li><a href=#最初のテスト>最初のテスト</a></li><li><a href=#2番目のテスト>2番目のテスト</a></li><li><a href=#例外のテスト>例外のテスト</a></li><li><a href=#引数のテスト>引数のテスト</a></li><li><a href=#完成したテスト>完成したテスト</a></li></ul></li><li><a href=#mockitoを使ったインテグレーションテスト>Mockitoを使ったインテグレーションテスト</a><ul><li><a href=#最初のテスト-1>最初のテスト</a></li><li><a href=#2番目のテスト-1>2番目のテスト</a></li><li><a href=#時間を予測可能にする>時間を予測可能にする</a></li><li><a href=#時間をコントロールする>時間をコントロールする</a></li><li><a href=#例外のテスト-1>例外のテスト</a></li><li><a href=#完成したテスト-1>完成したテスト</a></li></ul></li><li><a href=#テスト駆動開発とユニットテストインテグレーションテスト>テスト駆動開発とユニットテスト・インテグレーションテスト</a></li></ul></nav></div></aside></main></body></html>